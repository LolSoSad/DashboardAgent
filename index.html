 <!DOCTYPE html>

<html class="h-full" lang="th">
<head>
<meta charset="utf-8"/>
<meta content="width=device-width, initial-scale=1.0" name="viewport"/>
<title>Forklift-rental-dashboard (Agent)</title>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css" rel="stylesheet"/>
<link href="https://fonts.googleapis.com/css2?family=Prompt:wght@300;400;500;600;700&amp;display=swap" rel="stylesheet"/>
<style>
      :root {
        --primary-color: #1F6FB2;  /* ‡∏ü‡πâ‡∏≤‡πÇ‡∏•‡πÇ‡∏Å‡πâ */
        --secondary-color: #FF7A1A; /* ‡∏™‡πâ‡∏°‡πÇ‡∏•‡πÇ‡∏Å‡πâ */
        --dark-text: #1e293b;
        --muted-text: #64748b;
        --bg-soft: #f5f7fb;
        --card-border: #e2e8f0;
      }
  
      * { box-sizing: border-box; }
  
      body {
        margin: 0;
        padding: 0;
        font-family: 'Prompt', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
        background: var(--bg-soft);
      }
  
      .main-wrapper {
        min-height: 100vh;
        padding: 2rem 1rem;
        background: var(--bg-soft);
      }
  
      .card {
        background: #ffffff;
        border-radius: 16px;
        padding: 1.5rem;
        border: 1px solid rgba(15, 23, 42, 0.05);
        box-shadow: 0 10px 26px rgba(15, 23, 42, 0.04);
        margin-bottom: 1rem;
      }
  
      .card-title {
        font-size: 1.1rem;
        font-weight: 700;
        color: var(--dark-text);
        margin: 0 0 1rem 0;
      }
  
      /* Stats */
      .stats-grid {
        display: grid;
        grid-template-columns: repeat(12, minmax(0, 1fr));
        gap: 1.25rem;
        margin-bottom: 0.75rem;
      }
      /* 6 / 6 columns (Bootstrap-like) */
      .stats-grid .dashboard-card { grid-column: span 6; }

      @media (max-width: 900px) {
        .stats-grid { grid-template-columns: repeat(12, minmax(0, 1fr)); }
        .stats-grid .dashboard-card { grid-column: span 12; }
      }
  
      .dashboard-card {
        position: relative;
        border: 1px solid rgba(15, 23, 42, 0.08);
        background-clip: padding-box;
        overflow: visible;
        border-radius: 18px;
        box-shadow: 0 2px 12px #b6c6e21a;
        background: #fff;
        padding: 2.6rem 1.2rem 1.5rem;
        transition: box-shadow 0.2s, transform 0.1s;
        border: none;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: flex-start;
        min-height: 190px;
      }
      .dashboard-card:hover {
        box-shadow: 0 8px 24px #b6c6e23a;
        transform: translateY(-2px);
      }
  
      .icon-bg {
        position: absolute;
        left: 50%;
        top: 0;
        transform: translate(-50%, -50%);
        width: 52px;
        height: 52px;
        border-radius: 50%;
        background: radial-gradient(circle at 30% 20%, #ffe7cf 0%, #ffd2a3 35%, #ffc48a 70%, #ffb36b 100%);
        display: flex;
        align-items: center;
        justify-content: center;
        box-shadow: 0 6px 15px rgba(255, 122, 26, 0.35);
        font-size: 1.4rem;
      }
      /* Icon color (orange) */
      .icon-bg i {
        color: var(--secondary-color);
      }
      /* Recolor PNG icon to orange */
      .icon-bg img {
        width: 30px;
        height: 30px;
        display: block;
        filter: brightness(0) saturate(100%) invert(56%) sepia(90%) saturate(1865%) hue-rotate(345deg) brightness(102%) contrast(101%);
      }

      .stat-value {
        font-size: 2rem;
        font-weight: 700;
        color: var(--primary-color);
        margin: 0.1rem 0;
        text-align: center;
      }
      .stat-title {
        font-size: 0.9rem;
        color: #7a8aa7;
        margin-top: 0.2rem;
        text-align: center;
      }
      .stat-breakdown {
        margin-top: 0.3rem;
        font-size: 0.78rem;
        color: #1f2937;
        width: 100%;
        max-width: 180px;
      }
      .stat-breakdown-row {
        display: flex;
        justify-content: space-between;
        gap: 0.75rem;
        font-weight: 600;
      }
      .stat-breakdown-row span:first-child {
        letter-spacing: 0.03em;
      }
      .stat-breakdown-row span:last-child {
        min-width: 40px;
        text-align: right;
        color: #1f2937;
      }
  
      /* Layout grid */
      .content-grid {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 1.25rem;
        margin-bottom: 1rem;
      }
      @media (max-width: 968px) {
        .content-grid { grid-template-columns: 1fr; }
      }
  
      /* Simple tables */
      .simple-table {
        width: 100%;
        border-collapse: collapse;
        font-size: 0.8rem;
      }
      .simple-table thead tr {
        background: #e5edf8;
        color: #1f2937;
      }
      .simple-table th,
      .simple-table td {
        padding: 0.5rem;
      }
      .simple-table th {
        font-weight: 600;
        text-align: left;
      }
      .simple-table td {
        border-bottom: 1px solid #edf2f7;
      }
  
          /* Charts */
      .chart-grid {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 1.25rem;
        margin-top: 0.5rem;
      }
      @media (max-width: 768px) {
        .chart-grid { grid-template-columns: 1fr; }
      }
      .chart-card {
        background: #f9fbff;
        border-radius: 12px;
        border: 1px solid #e5edf8;
        padding: 1rem 1.25rem;
      }
      .chart-title {
        font-size: 0.9rem;
        font-weight: 600;
        color: var(--dark-text);
        margin-bottom: 0.4rem;
      }
      .chart-subtitle {
        font-size: 0.75rem;
        color: var(--muted-text);
        margin-bottom: 0.6rem;
      }
  
      .chart-filters {
        display: flex;
        flex-wrap: wrap;
        gap: 0.5rem;
        margin-bottom: 0.75rem;
      }
  
      .chart-filters select {
        padding: 0.3rem 0.75rem;
        border-radius: 6px;
        border: 1px solid #d1d5db;
        background: #ffffff;
        font-size: 0.8rem;
        font-family: 'Prompt', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
        color: #374151;
      }
      /* ‡∏Å‡∏£‡∏≤‡∏ü‡πÅ‡∏ó‡πà‡∏á‡πÅ‡∏ô‡∏ß‡∏ï‡∏±‡πâ‡∏á */
      .chart-bars {
        display: flex;
        align-items: flex-end;
        justify-content: space-between;
        gap: 0.75rem;
        height: 180px;
        padding: 0.25rem 0.25rem 0.1rem;
      }
      .chart-bar-col {
        flex: 1;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: flex-end;
        height: 100%;
        gap: 0.35rem;
        font-size: 0.78rem;
      }
      .chart-bar-outer {
        height: 100%;
        display: flex;
        align-items: flex-end;
        width: 100%;
        max-width: 26px;
        background: #e5edf8;
        border-radius: 8px;
        overflow: hidden;
      }
      .chart-bar {
        width: 100%;
        border-radius: 8px 8px 0 0;
      }
      .chart-bar.contracts {
        background: linear-gradient(180deg, var(--primary-color), #4fa0e6);
      }
      .chart-bar.revenue {
        background: linear-gradient(180deg, var(--secondary-color), #ff9b42);
      }
      .chart-value {
        font-size: 0.8rem;
        font-weight: 600;
        color: var(--dark-text);
      }
      .chart-label {
        font-size: 0.78rem;
        color: var(--muted-text);
        text-align: center;
      }
  
      /* Lists */
      .scroll-list {
        max-height: 320px;
        overflow-y: auto;
        padding-right: 4px;
        margin-right: -4px;
      }
  
      .contract-item {
        padding: 1rem;
        border-radius: 12px;
        background: #f9fbff;
        margin-bottom: 0.75rem;
        border: 1px solid #e5edf8;
      }
      .contract-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 0.4rem;
      }
      .contract-id {
        font-weight: 600;
        font-size: 0.9rem;
        color: var(--dark-text);
      }
      .status-badge {
        display: inline-block;
        padding: 0.2rem 0.7rem;
        border-radius: 999px;
        font-size: 0.75rem;
        font-weight: 600;
      }
      .status-active {
        background: #e3f0ff;
        color: var(--primary-color);
      }
      .status-pending {
        background: #fff3dc;
        color: #b45309;
      }
      .status-approved {
        background: #e0fcef;
        color: #047857;
      }
      .contract-amount {
        font-weight: 700;
        font-size: 1.05rem;
        color: var(--primary-color);
        margin-bottom: 0.25rem;
      }
      .contract-details {
        display: flex;
        justify-content: space-between;
        font-size: 0.8rem;
        color: var(--muted-text);
        gap: 0.75rem;
      }
      .contract-meta {
        list-style-type: disc;
        padding-left: 1.1rem;
        margin: 0.15rem 0 0;
        font-size: 0.78rem;
        color: var(--muted-text);
      }
  
      .quotation-item {
        display: flex;
        justify-content: space-between;
        align-items: flex-start;
        padding: 0.9rem 0;
        border-bottom: 1px solid #edf2f7;
      }
      .quotation-item:last-child { border-bottom: none; }
      .quotation-info h4 {
        margin: 0 0 0.15rem 0;
        font-size: 0.85rem;
        font-weight: 600;
        color: var(--dark-text);
      }
      .quotation-info p {
        margin: 0;
        font-size: 0.8rem;
        color: var(--muted-text);
      }
      .quotation-meta {
        list-style-type: disc;
        padding-left: 1.1rem;
        margin: 0.25rem 0 0;
        font-size: 0.78rem;
        color: var(--muted-text);
      }
      .quotation-amount {
        font-size: 1rem;
        font-weight: 700;
        color: var(--primary-color);
        margin: 0 0 0.3rem 0;
        text-align: right;
      }
  
      /* Timeline */
      .payment-timeline { position: relative; }
      .timeline-item {
        position: relative;
        padding-left: 2rem;
        padding-bottom: 1.1rem;
      }
      .timeline-item:last-child { padding-bottom: 0; }
      .timeline-item::before {
        content: '';
        position: absolute;
        left: 0.45rem;
        top: 0.6rem;
        bottom: -1.1rem;
        width: 2px;
        background: #e2e8f0;
      }
      .timeline-item:last-child::before { display: none; }
      .timeline-dot {
        position: absolute;
        left: 0;
        top: 0.25rem;
        width: 1rem;
        height: 1rem;
        border-radius: 50%;
        background: #ffffff;
        border: 3px solid var(--secondary-color);
      }
      .timeline-content h4 {
        margin: 0 0 0.15rem 0;
        font-size: 0.85rem;
        font-weight: 600;
        color: var(--dark-text);
      }
      .timeline-content p {
        margin: 0 0 0.2rem 0;
        font-size: 0.78rem;
        color: var(--muted-text);
      }
      .timeline-amount {
        font-size: 0.95rem;
        font-weight: 700;
        color: var(--primary-color);
      }
  
      /* Fleet summary */
      .financial-summary {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 0.9rem;
        margin-top: 0.5rem;
      }
      .summary-item {
        padding: 0.85rem 0.9rem;
        background: #f9fbff;
        border-radius: 12px;
        border: 1px solid #e5edf8;
      }
      .summary-item.warning {
        background: #fff7e6;
        border-color: #fed7aa;
      }
      .summary-label {
        font-size: 0.8rem;
        color: var(--muted-text);
        margin-bottom: 0.3rem;
        font-weight: 500;
      }
      .summary-value {
        font-size: 1.3rem;
        font-weight: 700;
        color: var(--primary-color);
      }
      .alert-box {
        padding: 0.85rem;
        background: #fff7e6;
        border-radius: 12px;
        border: 1px solid #fed7aa;
        margin-top: 0.8rem;
        font-size: 0.8rem;
        color: #b45309;
      }
      .alert-title {
        font-weight: 600;
        margin-bottom: 0.35rem;
      }
      .alert-item { margin-bottom: 0.15rem; }
      .maintenance-list {
        display: flex;
        flex-direction: column;
        gap: 0.4rem;
        margin-top: 0.25rem;
      }
      .maintenance-card {
        padding: 0.45rem 0.7rem;
        border-radius: 10px;
        background: #ffffff;
        border: 1px solid #fed7aa;
        display: flex;
        justify-content: space-between;
        align-items: center;
        font-size: 0.78rem;
        color: #b45309;
      }
      .maintenance-card span:first-child {
        font-weight: 700;
      }
  
      /* ‡πÅ‡∏ñ‡∏ß‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠‡∏Å‡∏≤‡∏£‡πå‡∏î + ‡∏õ‡∏∏‡πà‡∏°‡∏î‡πâ‡∏≤‡∏ô‡∏Ç‡∏ß‡∏≤ */
      .card-header-row {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 1rem;
      }
  
      /* ‡∏õ‡∏∏‡πà‡∏° "‡∏™‡∏±‡∏ç‡∏ç‡∏≤‡πÄ‡∏ä‡πà‡∏≤‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î" */
      .card-link-btn {
        font-size: 0.8rem;
        padding: 0.4rem 1.2rem;
        border-radius: 999px;
        border: none;
        background: #1F6FB2; /* blue */
        color: #ffffff;
        font-weight: 600;
        cursor: pointer;
        box-shadow: 0 4px 10px rgba(31, 111, 178, 0.35);
        transition: background 0.15s, box-shadow 0.15s, transform 0.1s;
      }
  
            .card-link-btn:hover {
        background: #185a95;
        box-shadow: 0 6px 14px rgba(31, 111, 178, 0.45);
        transform: translateY(-1px);
        color: #ffffff;
      }

      /* Agent dropdown top-right */
      .sale-dropdown {
        position: relative;
      }
      .sale-toggle-btn {
        padding: 0.4rem 1.4rem;
        border-radius: 999px;
        border: 1px solid #e5e7eb;
        background: #ffffff;
        font-size: 0.85rem;
        font-weight: 600;
        color: var(--dark-text);
        cursor: pointer;
        box-shadow: 0 4px 12px rgba(15,23,42,0.08);
        display: inline-flex;
        align-items: center;
        gap: 0.25rem;
      }
      .sale-toggle-btn:hover {
        background: #f9fafb;
      }
      .sale-dropdown-menu {
        position: absolute;
        right: 0;
        top: calc(100% + 0.4rem);
        min-width: 190px;
        background: #ffffff;
        border-radius: 12px;
        border: 1px solid #e5e7eb;
        box-shadow: 0 12px 30px rgba(15,23,42,0.18);
        padding: 0.4rem 0;
        display: none;
        z-index: 20;
      }
      .sale-dropdown-menu a {
        display: block;
        padding: 0.5rem 1rem;
        font-size: 0.85rem;
        color: #111827;
        text-decoration: none;
        white-space: nowrap;
      }
      .sale-dropdown-menu a:hover {
        background: #f3f4ff;
        color: var(--primary-color);
      }
      .sale-dropdown-menu a.active {
        font-weight: 600;
        background: #e5edf8;
        color: var(--primary-color);
      }
      .sale-dropdown.open .sale-dropdown-menu {
        display: block;
      }
    
      /* Multi-select dropdown (checkbox) */
      .mdrop{position:relative;width:100%;}
      .mdrop-btn{width:100%;display:flex;align-items:center;justify-content:space-between;gap:0.75rem;
        padding:0.55rem 0.75rem;border-radius:10px;border:1px solid #e5e7eb;background:#fff;
        font-family:'Prompt',sans-serif;cursor:pointer;}
      .mdrop-btn:focus{outline:none;box-shadow:0 0 0 3px rgba(31,111,178,0.18);}
      .mdrop-caret{opacity:0.7;}
      .mdrop-panel{position:absolute;left:0;right:0;top:calc(100% + 8px);z-index:50;
        background:#fff;border:1px solid #e5e7eb;border-radius:12px;box-shadow:0 12px 28px rgba(2,6,23,0.12);
        padding:0.5rem;display:none;max-height:280px;overflow:auto;}
      .mdrop.open .mdrop-panel{display:block;}
      .mdrop-actions{display:flex;gap:0.5rem;justify-content:flex-end;position:sticky;top:0;background:#fff;padding-bottom:0.5rem;margin-bottom:0.25rem;border-bottom:1px solid #f1f5f9;}
      .mdrop-action{border:1px solid #e5e7eb;background:#fff;border-radius:999px;padding:0.35rem 0.7rem;cursor:pointer;font-weight:600;font-size:0.78rem;}
      .mdrop-action:hover{background:#f8fafc;}
      .mdrop-list{display:flex;flex-direction:column;gap:0.25rem;}
      .mdrop-item{display:flex;align-items:center;gap:0.55rem;padding:0.45rem 0.55rem;border-radius:10px;cursor:pointer;}
      .mdrop-item:hover{background:#f8fafc;}
      .mdrop-item input{width:16px;height:16px;}
      .mdrop-item span{font-size:0.9rem;color:#0f172a;}

    
      .chart-canvas-wrap{position:relative; height:320px; width:100%;}
      .chart-canvas-wrap canvas{width:100% !important; height:100% !important;}
/* ==== FIX: icon not overflow card + align top equally ==== */
.dashboard-card{
  position: relative;
  overflow: hidden;
  padding-top: 78px; /* space for icon */
}
.dashboard-card .icon-bg{
  top: 14px !important;
  transform: translateX(-50%) !important; /* keep centered, no Y lift */
}
.dashboard-card .stat-value{ margin-top: 10px; }
/* small screens */
@media (max-width: 520px){
  .dashboard-card{ padding-top: 72px; }
  .dashboard-card .icon-bg{
    top: 10px !important;
    width: 46px;
    height: 46px;
    font-size: 1.25rem;
  }
}
/* ==== END FIX ==== */

/* ===== Reset buttons (make red) ===== */
button[id$="ResetBtn"], 
#saleResetBtn, 
#forkliftResetBtn {
  background: #dc3545 !important;
  color: #ffffff !important;
  border: none !important;
  box-shadow: 0 8px 20px rgba(220,53,69,0.22) !important;
}
button[id$="ResetBtn"]:hover, 
#saleResetBtn:hover, 
#forkliftResetBtn:hover {
  background: #bb2d3b !important;
}
button[id$="ResetBtn"]:active, 
#saleResetBtn:active, 
#forkliftResetBtn:active {
  transform: translateY(1px);
}


/* ===== Apply/Update & Reset buttons (same size) ===== */
#saleApplyBtn, #saleResetBtn,
#forkliftUpdateBtn, #forkliftResetBtn,
#applyBtn, #resetBtn,
button[id$="ApplyBtn"], button[id$="UpdateBtn"], button[id$="ResetBtn"]{
  height: 38px !important;
  min-width: 110px;
  padding: 0 18px !important;
  display: inline-flex;
  align-items: center;
  justify-content: center;
  gap: 8px;
  line-height: 1 !important;
  font-size: 0.85rem;
  font-weight: 700;
  border-radius: 999px;
}


/* === Single sale polish === */
#singleSaleHeader{position:sticky; top:0; z-index:5; background:var(--bg-soft); padding-top:0.25rem;}
.contract-id, .quotation-info h4{letter-spacing:0.01em;}
.contract-item, .quotation-item{transition:transform .12s ease, box-shadow .12s ease;}
.contract-item:hover, .quotation-item:hover{transform:translateY(-1px); box-shadow:0 10px 22px rgba(15,23,42,0.06);}

</style>
</head>
<body class="h-full">
<div class="main-wrapper">
<div style="max-width: 1400px; margin: 0 auto; padding: 0 0.25rem;">

    <!-- Stats Grid (Agent system overview) -->
    <div class="stats-grid" style="margin-top:0.5rem;">
      <!-- ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏£‡∏ñ‡∏ó‡∏µ‡πà‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÉ‡∏´‡πâ‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£ -->
      <div class="dashboard-card text-center">
        <div class="icon-bg"><img alt="forklift" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAB0AAAAWCAYAAAA8VJfMAAAD6klEQVR4nH2VTW9bRRSGn2M7jmPHceIkTppP0ZQFBIUUCbYs6K70D/ATkFjwb2DHih1iQWGFkAAJgZoSyYqoEkKbmjohIR9O6jix4zuHxZnre6+bMNJo7sydmXPe9z3njOizH0BSvqdBxL4BVAEFdeACG7VvTKwHfXN/tm/MoA4QwJmhiyYcbNkm1BvG5pksjM5Brmjrl03otiFXiF0adqIRTfSMfTjQlC2e7cKvXyhBh2RTY6A0A+9+JIxU4Ogp1DeU1QeCpG2bRNujb/ETW8zgnM3FexJcQecc3roPxYokaG7Ule2f4NGXyvsfC9kCNOrQbsGgR+ucBxFKo6+wkOnRqhLRiMKtZWHidkSLOghWhYFBZeM72PkNZlfM2P4mLLzj9/omGpt6lN5EChcGQywIQuPhmgsMgQjM3xXyY/Dke7u1vAg7a9pDQ7+2MT29zilD6ryxsIdG+/6pQn4UyvPQasDBNlSWhEYdmodJpP3xEGupCEkArmuIFI+ym2QhZGJiSXABHGwrI9NQKMOLqtrZfpTxlHEeaW8SLSaQ9vIyhro8b+PLfehewsJd+GcTup2Iyngk97UMGgBhMRAzArC/pbRO7Fh+FEqzPh4cDI9DNg8XZ9A6gbkV4a9flNNd75Am8zyhba84+EWn4K7MaPWbSIx8Ce59aikSohibg9M9KxAjFSjdguOaUp67Ad91mu49gfWvlK0ftYc2bK1TqH6ruCvTWQMYm4WrC2g37XzldWjswmUrksP1S+d8noZl8EVVef74Zvf+Xgd1SspL8fIQgi7UfleOaxZM7RZcnkJ28H9w9owS5edNLehC7Rqn/n1qvXLHavDZvlKcFEMFibylV5F80uaKvhymYHDY5i4w+trnseINpAcsmMZmzdnGngVVcclyd3bZO9qGTguax9DYVabuCIVyrPYWJ2zj8ASMTNMrfaMzcPgMzk/svwhM3k46kx6Awpg52TyEoxo0j5TTPSsikoLSNKQy/mkL3S9OCYgyMmUXv/ae0LmAnUfKUMkOqxoLAmSHYOW+4Bysf60EXchlIJ2F6kOlMA7jizC7LOSKMJAjrMGmqQoUJ+GDT4S9TUXUnrBuG+obsLAqvP3AnEul4c+flW4HMoPmSGYwov2Ne0I2Z86R1DJkL4Oqf9aAoRKMVITnj5X8JnQulG4bhictVy34YGZZqD609AopXflQGJ1+1Ui8+2onuvZ5FIkiVsr2/lBO6qbFzJtCeSER8qiazkc1RYDyojC+cA0yuC6KRdc+i10Ye1ODK5tnspExiC5D/QOgRnn/E0ZorK8MqotFb9xoqE/oQMJo7FtiTmrcqf53NMnAf9wUvnP34lXsAAAAAElFTkSuQmCC" style="width:30px; height:30px; object-fit:contain; display:block;"></div>
        <div class="stat-value">45</div>
        <div class="stat-title">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏£‡∏ñ‡∏ó‡∏µ‡πà‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÉ‡∏´‡πâ‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£</div>
      </div>

      <!-- ‡∏ö‡∏±‡∏ç‡∏ä‡∏µ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î -->
      <div class="dashboard-card text-center">
        <div class="icon-bg"><i class="fas fa-users"></i></div>
        <div class="stat-value">155</div>
        <div class="stat-title">‡∏ö‡∏±‡∏ç‡∏ä‡∏µ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</div>

        <div class="stat-breakdown">
          <div class="stat-breakdown-row"><span>‡∏ö‡∏±‡∏ç‡∏ä‡∏µ‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å</span><span>100</span></div>
	  <div class="stat-breakdown-row"><span>‡∏ö‡∏±‡∏ç‡∏ä‡∏µ‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤</span><span>55</span></div>
        </div>
      </div>
    </div>


<!-- Stats Grid -->

<!-- ‡∏™‡∏£‡∏∏‡∏õ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡πà‡∏≤ : Compare Agent + Date Range -->
<div class="card" id="monthly-sale-summary" style="max-width: 1400px; margin: 0 auto;">
<h2 class="card-title">‡∏™‡∏£‡∏∏‡∏õ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡πà‡∏≤ (‡πÉ‡∏ö‡πÄ‡∏™‡∏ô‡∏≠‡∏£‡∏≤‡∏Ñ‡∏≤‡πÄ‡∏ó‡∏µ‡∏¢‡∏ö‡∏™‡∏±‡∏ç‡∏ç‡∏≤‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£)</h2>
<p style="font-size: 0.85rem; color: var(--muted-text); margin-top: -0.25rem; margin-bottom: 0.9rem;">
    ‡πÄ‡∏õ‡∏£‡∏µ‡∏¢‡∏ö‡πÄ‡∏ó‡∏µ‡∏¢‡∏ö‡∏ú‡∏•‡∏á‡∏≤‡∏ô‡∏Ç‡∏≠‡∏á Agent ‡∏ï‡∏≤‡∏°‡∏ä‡πà‡∏ß‡∏á‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å (‡∏£‡∏ß‡∏°‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÉ‡∏ö‡πÄ‡∏™‡∏ô‡∏≠‡∏£‡∏≤‡∏Ñ‡∏≤ ‡πÅ‡∏•‡∏∞‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏™‡∏±‡∏ç‡∏ç‡∏≤‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£)
  </p>
<!-- Filters -->
<div style="display:flex; flex-wrap:wrap; gap:0.75rem; align-items:flex-end; margin-bottom:1rem;">
<div style="min-width:220px;">
<div style="font-size:0.78rem; color:var(--muted-text); margin-bottom:0.35rem;">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ä‡πà‡∏ß‡∏á‡∏ß‡∏±‡∏ô‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô</div>
<input id="saleStartDate" style="width:100%; padding:0.55rem 0.75rem; border-radius:10px; border:1px solid #e5e7eb; font-family:'Prompt',sans-serif;" type="date"/>
</div>
<div style="min-width:220px;">
<div style="font-size:0.78rem; color:var(--muted-text); margin-bottom:0.35rem;">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ä‡πà‡∏ß‡∏á‡∏ß‡∏±‡∏ô‡∏™‡∏¥‡πâ‡∏ô‡∏™‡∏∏‡∏î</div>
<input id="saleEndDate" style="width:100%; padding:0.55rem 0.75rem; border-radius:10px; border:1px solid #e5e7eb; font-family:'Prompt',sans-serif;" type="date"/>
</div>
<div style="display:flex; gap:0.5rem; flex-wrap:wrap;">
<button id="saleApplyBtn" style="padding:0.6rem 1rem; border-radius:999px; border:none; background:var(--primary-color); color:#fff; font-weight:700; cursor:pointer; box-shadow: 0 4px 10px rgba(31,111,178,0.35);" type="button">
        ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï
      </button>
<button id="saleResetBtn" style="padding:0.6rem 1rem; border-radius:999px; border:1px solid #e5e7eb; background:#fff; color:#111827; font-weight:700; cursor:pointer;" type="button">
        ‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï
      </button>
</div>
</div>
<!-- Summary chips -->
<div id="saleSummaryChips" style="display:grid; grid-template-columns: repeat(auto-fit,minmax(180px,1fr)); gap: 0.75rem; margin-bottom: 1rem;">
</div>
<!-- Chart -->
<div class="chart-card" style="background:#ffffff; border:1px solid #e5edf8;">
<div class="chart-title">‡∏Å‡∏£‡∏≤‡∏ü‡πÄ‡∏õ‡∏£‡∏µ‡∏¢‡∏ö‡πÄ‡∏ó‡∏µ‡∏¢‡∏ö‡πÉ‡∏ö‡πÄ‡∏™‡∏ô‡∏≠‡∏£‡∏≤‡∏Ñ‡∏≤‡πÅ‡∏•‡∏∞‡∏™‡∏±‡∏ç‡∏ç‡∏≤‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£ (‡∏£‡∏≤‡∏¢‡πÄ‡∏î‡∏∑‡∏≠‡∏ô)</div>
<div class="chart-subtitle">‡πÅ‡∏™‡∏î‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Ç‡∏≠‡∏á Agent 1 ‡∏Ñ‡∏ô (‡∏ï‡∏±‡∏î‡πÄ‡∏õ‡πá‡∏ô‡πÅ‡∏ó‡πà‡∏á‡∏£‡∏≤‡∏¢‡πÄ‡∏î‡∏∑‡∏≠‡∏ô) ‡πÉ‡∏ô‡∏ä‡πà‡∏ß‡∏á‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å</div>
<div style="position:relative; min-height:260px;">
<canvas id="saleCompareChart"></canvas>
</div>
</div>
</div>
</div>
<!-- Charts -->
<div class="card" id="monthly-forklift-summary" style="max-width: 1400px; margin: 0 auto; margin-top: 15px;">
<h2 class="card-title">‡∏™‡∏£‡∏∏‡∏õ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡πà‡∏≤ (‡∏£‡∏ñ‡∏¢‡∏Å‡πÉ‡∏ô‡πÉ‡∏ö‡πÄ‡∏™‡∏ô‡∏≠‡∏£‡∏≤‡∏Ñ‡∏≤‡πÄ‡∏ó‡∏µ‡∏¢‡∏ö‡∏£‡∏ñ‡∏¢‡∏Å‡πÉ‡∏ô‡∏™‡∏±‡∏ç‡∏ç‡∏≤‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£)</h2>
<p style="font-size: 0.85rem; color: var(--muted-text); margin-top: -0.25rem; margin-bottom: 0.9rem;">
    ‡πÄ‡∏õ‡∏£‡∏µ‡∏¢‡∏ö‡πÄ‡∏ó‡∏µ‡∏¢‡∏ö‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏£‡∏ñ‡∏¢‡∏Å‡∏ï‡∏≤‡∏°‡∏ä‡πà‡∏ß‡∏á‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å (‡∏£‡∏ß‡∏°‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏£‡∏ñ‡∏¢‡∏Å‡πÉ‡∏ô‡πÉ‡∏ö‡πÄ‡∏™‡∏ô‡∏≠‡∏£‡∏≤‡∏Ñ‡∏≤ ‡πÅ‡∏•‡∏∞‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏£‡∏ñ‡∏¢‡∏Å‡πÉ‡∏ô‡∏™‡∏±‡∏ç‡∏ç‡∏≤‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£) ‚Äî ‡∏≠‡πâ‡∏≤‡∏á‡∏≠‡∏¥‡∏á‡∏à‡∏≤‡∏Å ‚Äú‡∏™‡∏£‡∏∏‡∏õ‡∏ä‡πà‡∏ß‡∏á‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å ‚Äù
  </p>
<!-- Filters (Forklift summary) -->
<div style="display:flex; flex-wrap:wrap; gap:0.75rem; align-items:flex-end; margin-bottom:1rem;">
<div style="min-width:220px;">
<div style="font-size:0.78rem; color:var(--muted-text); margin-bottom:0.35rem;">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ä‡πà‡∏ß‡∏á‡∏ß‡∏±‡∏ô‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô</div>
<input id="forkliftStartDate" style="width:100%; padding:0.55rem 0.75rem; border-radius:10px; border:1px solid #e5e7eb; font-family:'Prompt',sans-serif;" type="date"/>
</div>
<div style="min-width:220px;">
<div style="font-size:0.78rem; color:var(--muted-text); margin-bottom:0.35rem;">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ä‡πà‡∏ß‡∏á‡∏ß‡∏±‡∏ô‡∏™‡∏¥‡πâ‡∏ô‡∏™‡∏∏‡∏î</div>
<input id="forkliftEndDate" style="width:100%; padding:0.55rem 0.75rem; border-radius:10px; border:1px solid #e5e7eb; font-family:'Prompt',sans-serif;" type="date"/>
</div>
<div style="display:flex; gap:0.5rem; align-items:flex-end;">
<button class="card-link-btn" id="forkliftUpdateBtn" type="button">‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï</button>
<button class="mdrop-action" id="forkliftResetBtn" style="padding:0.45rem 1.1rem; height:38px;" type="button">‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï</button>
</div>
</div>
<!-- Summary chips -->
<div id="forkliftSummaryChips" style="display:grid; grid-template-columns: repeat(auto-fit,minmax(260px,1fr)); gap:0.75rem; margin-bottom: 1rem;"></div>
<!-- Chart: Compare forklift in quotation vs contract -->
<div class="chart-card" style="background:#ffffff; border:1px solid #e5edf8; margin-top:1rem;">
<div class="chart-title">‡∏Å‡∏£‡∏≤‡∏ü‡πÄ‡∏õ‡∏£‡∏µ‡∏¢‡∏ö‡πÄ‡∏ó‡∏µ‡∏¢‡∏ö‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏£‡∏ñ‡∏¢‡∏Å (‡πÉ‡∏ö‡πÄ‡∏™‡∏ô‡∏≠‡∏£‡∏≤‡∏Ñ‡∏≤ vs ‡∏™‡∏±‡∏ç‡∏ç‡∏≤‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£) (‡∏£‡∏≤‡∏¢‡πÄ‡∏î‡∏∑‡∏≠‡∏ô)</div>
<div class="chart-subtitle">‡∏ï‡∏±‡∏î‡πÄ‡∏õ‡πá‡∏ô‡πÅ‡∏ó‡πà‡∏á‡∏£‡∏≤‡∏¢‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏ï‡∏≤‡∏°‡∏ä‡πà‡∏ß‡∏á‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö Agent 1 ‡∏Ñ‡∏ô</div>
<div style="position:relative; min-height:260px;">
<div class="chart-canvas-wrap"><canvas id="forkliftCompareChart"></canvas></div>
<div id="forkliftCompareFallback" style="margin-top:0.75rem;"></div>
</div>
</div>
</div>
<div class="card" style="max-width: 1400px; margin: 0 auto; margin-top: 15px;">
<h2 class="card-title">‡∏Å‡∏£‡∏≤‡∏ü‡∏™‡∏£‡∏∏‡∏õ‡∏£‡∏∏‡πà‡∏ô‡∏£‡∏ñ‡∏¢‡∏Å‡∏ó‡∏µ‡πà‡∏ó‡∏≥‡∏™‡∏±‡∏ç‡∏ç‡∏≤ (Agent ‡∏Ñ‡∏ô‡πÄ‡∏î‡∏µ‡∏¢‡∏ß)</h2>
<p style="font-size:0.8rem; color:var(--muted-text); margin-top:-0.2rem; margin-bottom:0.6rem;">
            ‡∏°‡∏≠‡∏á‡∏†‡∏≤‡∏û‡∏£‡∏ß‡∏° ‚Äú‡∏£‡∏∏‡πà‡∏ô‡∏£‡∏ñ‡∏¢‡∏Å‡∏ó‡∏µ‡πà‡∏ó‡∏≥‡∏™‡∏±‡∏ç‡∏ç‡∏≤‚Äù ‡πÅ‡∏•‡∏∞ ‚Äú‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏£‡∏ñ‡∏¢‡∏Å‡∏ó‡∏µ‡πà Agent ‡∏ó‡∏≥‡∏™‡∏±‡∏ç‡∏ç‡∏≤‚Äù (‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≥‡∏•‡∏≠‡∏á)</p>
<div class="chart-grid">
<!-- ‡∏ã‡πâ‡∏≤‡∏¢: ‡∏Å‡∏£‡∏≤‡∏ü‡∏™‡∏£‡∏∏‡∏õ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏™‡∏±‡∏ç‡∏ç‡∏≤ -->
<div class="chart-card">
<div class="card-title" style="font-size:0.9rem;">‡∏Å‡∏£‡∏≤‡∏ü‡∏™‡∏£‡∏∏‡∏õ‡∏£‡∏∏‡πà‡∏ô‡∏£‡∏ñ‡∏¢‡∏Å‡∏ó‡∏µ‡πà‡∏ó‡∏≥‡∏™‡∏±‡∏ç‡∏ç‡∏≤</div>
<div class="chart-filters">
<div style="display:flex; gap:0.5rem; flex-wrap:wrap; align-items:center;">
<div style="display:flex; flex-direction:column; gap:0.25rem;">
<div style="font-size:0.75rem; color:var(--muted-text);">‡∏ä‡πà‡∏ß‡∏á‡∏ß‡∏±‡∏ô‡πÄ‡∏£‡∏¥‡πà‡∏° (Start)</div>
<input id="modelStartDate" style="padding:0.45rem 0.7rem; border-radius:0.6rem; border:1px solid #e5e7eb; width:170px; font-family:'Prompt',sans-serif;" type="date"/>
</div>
<div style="display:flex; flex-direction:column; gap:0.25rem;">
<div style="font-size:0.75rem; color:var(--muted-text);">‡∏ä‡πà‡∏ß‡∏á‡∏ß‡∏±‡∏ô‡∏™‡∏¥‡πâ‡∏ô‡∏™‡∏∏‡∏î (End)</div>
<input id="modelEndDate" style="padding:0.45rem 0.7rem; border-radius:0.6rem; border:1px solid #e5e7eb; width:170px; font-family:'Prompt',sans-serif;" type="date"/>
</div>
</div>
</div>
<div style="position:relative; min-height:220px; margin-top: 55px;">
<canvas id="modelHoursChart"></canvas>
</div>
</div>
<!-- ‡∏Ç‡∏ß‡∏≤: ‡∏Å‡∏£‡∏≤‡∏ü‡∏™‡∏£‡∏∏‡∏õ‡∏Å‡∏≤‡∏£‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô‡πÅ‡∏û‡πá‡∏Ñ/‡∏ä‡∏°. (‡πÅ‡∏ó‡πà‡∏á‡∏™‡∏µ‡∏™‡πâ‡∏°) -->
<div class="chart-card">
<div class="card-title" style="font-size:0.9rem;">‡∏Å‡∏£‡∏≤‡∏ü‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏£‡∏ñ‡∏¢‡∏Å‡∏ó‡∏µ‡πà Agent ‡∏ó‡∏≥‡∏™‡∏±‡∏ç‡∏ç‡∏≤</div>
<div class="chart-subtitle" style="margin-top:-0.35rem;">
      ‡πÅ‡∏™‡∏î‡∏á‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏£‡∏ñ‡∏¢‡∏Å‡∏ó‡∏µ‡πà‡∏ó‡∏≥‡∏™‡∏±‡∏ç‡∏ç‡∏≤ ‡πÅ‡∏¢‡∏Å‡∏ï‡∏≤‡∏° Agent (‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≥‡∏•‡∏≠‡∏á) ‡∏ï‡∏≤‡∏°‡∏ä‡πà‡∏ß‡∏á‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÅ‡∏•‡∏∞ Agent ‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å
    </div>
<div class="chart-filters" style="margin-top: 8px;">
<div style="display:flex; gap:0.5rem; flex-wrap:wrap; align-items:center;">
<div style="display:flex; flex-direction:column; gap:0.25rem;">
<div style="font-size:0.75rem; color:var(--muted-text);">‡∏ä‡πà‡∏ß‡∏á‡∏ß‡∏±‡∏ô‡πÄ‡∏£‡∏¥‡πà‡∏° (Start)</div>
<input id="saleForkStartDate" style="width:100%; padding:0.55rem 0.75rem; border-radius:10px; border:1px solid #e5e7eb; width:170px; font-family:'Prompt',sans-serif;" type="date"/>
</div>
<div style="display:flex; flex-direction:column; gap:0.25rem;">
<div style="font-size:0.75rem; color:var(--muted-text);">‡∏ä‡πà‡∏ß‡∏á‡∏ß‡∏±‡∏ô‡∏™‡∏¥‡πâ‡∏ô‡∏™‡∏∏‡∏î (End)</div>
<input id="saleForkEndDate" style="width:100%; padding:0.55rem 0.75rem; border-radius:10px; border:1px solid #e5e7eb; width:170px; font-family:'Prompt',sans-serif;" type="date"/>
</div>
</div>
</div>
<div style="position:relative; min-height:220px; margin-top: 30px;">
<canvas id="saleForkliftChart"></canvas>
</div>
</div>
</div>
</div>

<div class="card" id="monthly-agent-revenue" style="max-width: 1400px; margin: 0 auto; margin-top: 15px;">
  <h2 class="card-title">‡∏£‡∏≤‡∏¢‡πÑ‡∏î‡πâ‡∏Ç‡∏≠‡∏á Agent (‡∏£‡∏≤‡∏¢‡πÄ‡∏î‡∏∑‡∏≠‡∏ô)</h2>
  <p style="font-size: 0.85rem; color: var(--muted-text); margin-top: -0.25rem; margin-bottom: 0.9rem;">
    ‡πÅ‡∏™‡∏î‡∏á‡∏Å‡∏£‡∏≤‡∏ü‡∏£‡∏≤‡∏¢‡πÑ‡∏î‡πâ‡πÅ‡∏ö‡∏ö‡∏£‡∏≤‡∏¢‡πÄ‡∏î‡∏∑‡∏≠‡∏ô ‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ä‡πà‡∏ß‡∏á‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà ‡πÅ‡∏•‡∏∞‡∏™‡∏£‡∏∏‡∏õ ‚Äú‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏°‡∏£‡∏≤‡∏¢‡πÑ‡∏î‡πâ‚Äù ‡∏ï‡∏≤‡∏°‡∏ä‡πà‡∏ß‡∏á‡πÄ‡∏ß‡∏•‡∏≤‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å
  </p>

  <div style="display:flex; flex-wrap:wrap; gap:0.75rem; align-items:flex-end; margin-bottom:1rem;">
    <div style="min-width:220px;">
      <div style="font-size:0.78rem; color:var(--muted-text); margin-bottom:0.35rem;">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ä‡πà‡∏ß‡∏á‡∏ß‡∏±‡∏ô‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô</div>
      <input id="revStartDate" type="date" style="width:100%; padding:0.55rem 0.75rem; border-radius:10px; border:1px solid #e5e7eb; font-family:'Prompt',sans-serif;" />
    </div>
    <div style="min-width:220px;">
      <div style="font-size:0.78rem; color:var(--muted-text); margin-bottom:0.35rem;">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ä‡πà‡∏ß‡∏á‡∏ß‡∏±‡∏ô‡∏™‡∏¥‡πâ‡∏ô‡∏™‡∏∏‡∏î</div>
      <input id="revEndDate" type="date" style="width:100%; padding:0.55rem 0.75rem; border-radius:10px; border:1px solid #e5e7eb; font-family:'Prompt',sans-serif;" />
    </div>

    <div style="display:flex; gap:0.5rem; flex-wrap:wrap;">
      <button id="revApplyBtn" type="button" style="padding:0.6rem 1rem; border-radius:999px; border:none; background:var(--primary-color); color:#fff; font-weight:700; cursor:pointer; box-shadow: 0 4px 10px rgba(31,111,178,0.35);">
        ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï
      </button>
      <button id="revResetBtn" type="button" style="padding:0.6rem 1rem; border-radius:999px; border:1px solid #e5e7eb; background:#fff; color:#111827; font-weight:700; cursor:pointer;">
        ‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï
      </button>
    </div>
  </div>

  <div style="display:grid; grid-template-columns: repeat(auto-fit, minmax(240px, 1fr)); gap:0.75rem; margin-bottom: 1rem;">
    <div style="padding: 1.05rem 1.15rem; background:#fff7ed; border-radius:12px; border:1px solid #fed7aa;">
      <div style="font-size:0.85rem; font-weight:800; color:#7c2d12; margin-bottom:0.35rem;">
        ‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏°‡∏£‡∏≤‡∏¢‡πÑ‡∏î‡πâ (‡∏ä‡πà‡∏ß‡∏á‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å)
      </div>
      <div id="revTotalValue" style="font-size:1.7rem; font-weight:900; color:var(--secondary-color); line-height:1.15;">
        ‡∏ø0
      </div>
      <div id="revRangeText" style="font-size:0.85rem; font-weight:700; color:#9a3412; margin-top:0.35rem;">
        ‚Äî
      </div>
    </div>

    <div style="padding: 1.05rem 1.15rem; background:#eff6ff; border-radius:12px; border:1px solid #bfdbfe;">
      <div style="font-size:0.85rem; font-weight:700; color:#0f172a; margin-bottom:0.35rem;">
        ‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢‡∏ï‡πà‡∏≠‡πÄ‡∏î‡∏∑‡∏≠‡∏ô (‡πÉ‡∏ô‡∏ä‡πà‡∏ß‡∏á‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å)
      </div>
      <div id="revAvgValue" style="font-size:1.7rem; font-weight:900; color:var(--primary-color); line-height:1.15;">
        ‡∏ø0
      </div>
      <div style="font-size:0.82rem; font-weight:600; color:#334155; margin-top:0.35rem;">
        ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏à‡∏≤‡∏Å‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô‡∏ä‡πà‡∏ß‡∏á‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà
      </div>
    </div>
  </div>

  <div class="chart-card" style="background:#ffffff; border:1px solid #e5edf8;">
    <div class="chart-title">‡∏Å‡∏£‡∏≤‡∏ü‡∏£‡∏≤‡∏¢‡πÑ‡∏î‡πâ‡∏Ç‡∏≠‡∏á Agent (‡∏£‡∏≤‡∏¢‡πÄ‡∏î‡∏∑‡∏≠‡∏ô)</div>
    <div class="chart-subtitle">‡∏ï‡∏±‡∏î‡πÄ‡∏õ‡πá‡∏ô‡πÅ‡∏ó‡πà‡∏á‡∏£‡∏≤‡∏¢‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏ï‡∏≤‡∏°‡∏ä‡πà‡∏ß‡∏á‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å (‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≥‡∏•‡∏≠‡∏á)</div>
    <div style="position:relative; min-height:300px;">
      <canvas id="agentRevenueChart"></canvas>
    </div>
  </div>
</div>

<!-- End Agent performance -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>

document.addEventListener('DOMContentLoaded', () => {
  const ensureChartJs = (done) => {
    if (window.Chart) return done(true);
    const sc = document.createElement('script');
    sc.src = 'https://cdn.jsdelivr.net/npm/chart.js';
    sc.onload = () => done(true);
    sc.onerror = () => done(false);
    document.head.appendChild(sc);
  };

  ensureChartJs(() => {

        const hasChart = typeof window.Chart !== 'undefined';

      // ========= Helpers =========
      const pad2 = (n) => String(n).padStart(2, '0');
      const toYMD = (d) => `${d.getFullYear()}-${pad2(d.getMonth()+1)}-${pad2(d.getDate())}`;
      const safeDate = (v) => {
        if (!v) return null;
        const d = new Date(v);
        return isNaN(d.getTime()) ? null : d;
      };

      const monthKey = (d) => `${d.getFullYear()}-${pad2(d.getMonth()+1)}`;
      const monthRangeKeys = (startDateStr, endDateStr) => {
        const s = safeDate(startDateStr);
        const e = safeDate(endDateStr);
        if (!s || !e) return [];
        const start = new Date(Math.min(s.getTime(), e.getTime()));
        const end = new Date(Math.max(s.getTime(), e.getTime()));
        const cur = new Date(start.getFullYear(), start.getMonth(), 1);
        const last = new Date(end.getFullYear(), end.getMonth(), 1);
        const keys = [];
        while (cur <= last) {
          keys.push(`${cur.getFullYear()}-${pad2(cur.getMonth()+1)}`);
          cur.setMonth(cur.getMonth() + 1);
        }
        return keys;
      };

      const formatRange = (startDateStr, endDateStr) => {
        const s = safeDate(startDateStr);
        const e = safeDate(endDateStr);
        if (!s || !e) return '';
        const ss = new Date(Math.min(s.getTime(), e.getTime()));
        const ee = new Date(Math.max(s.getTime(), e.getTime()));
        const sTxt = `${pad2(ss.getDate())}/${pad2(ss.getMonth()+1)}/${ss.getFullYear()}`;
        const eTxt = `${pad2(ee.getDate())}/${pad2(ee.getMonth()+1)}/${ee.getFullYear()}`;
        return `${sTxt} - ${eTxt}`;
      };

      // ========= Mock data (stable) =========
      // saleMonthly: { saleName: { 'YYYY-MM': { c: quotations, u: services } } }
      const ACTIVE_AGENT = '‡∏Ñ‡∏∏‡∏ì‡πÄ‡∏≠'; // Agent ‡∏Ñ‡∏ô‡πÄ‡∏î‡∏µ‡∏¢‡∏ß
      const sales = [ACTIVE_AGENT];
      const saleMonthly = (() => {
        const obj = {};
        sales.forEach((s) => (obj[s] = {}));
        const years = [2024, 2025];
        years.forEach((y) => {
          for (let m = 1; m <= 12; m++) {
            const mk = `${y}-${pad2(m)}`;
            sales.forEach((s, si) => {
              // Deterministic pattern (no random)
              const base = ((y - 2023) * 7 + m * 3 + si * 5) % 12;
              const services = Math.max(1, 3 + (base % 7));          // 3..9
              const quotations = Math.max(services, services + (base % 4) + 1); // >= services
              obj[s][mk] = { c: quotations, u: services };
            });
          }
        });
        return obj;
      })();


      // ========= Revenue (mock data, stable) =========
      // revenueMonthly: { saleName: { 'YYYY-MM': revenueAmount } }
      const revenueMonthly = (() => {
        const obj = {};
        sales.forEach((s) => (obj[s] = {}));
        const years = [2024, 2025];
        years.forEach((y) => {
          for (let m = 1; m <= 12; m++) {
            const mk = `${y}-${pad2(m)}`;
            sales.forEach((s, si) => {
              // Deterministic monthly revenue (THB) ‚Äì no random
              // roughly 180k..620k with seasonality
              const wave = (Math.sin((m / 12) * Math.PI * 2) + 1) / 2; // 0..1
              const base = 180000 + ((y - 2024) * 45000) + (si * 12000);
              const seasonal = Math.round(240000 * wave);
              const bump = ((y * 17 + m * 29 + si * 7) % 9) * 12000;
              obj[s][mk] = base + seasonal + bump;
            });
          }
        });
        return obj;
      })();


      // transactions for forklift-by-sale-by-model chart
      const forkliftModels = ['LHE','LPE','RRE'];
      const saleForkTx = (() => {
        const tx = [];
        const years = [2024, 2025];
        const days = [3, 12, 24];
        years.forEach((y, yi) => {
          for (let m = 1; m <= 12; m++) {
            sales.forEach((sale, si) => {
              forkliftModels.forEach((model, mi) => {
                const base = (yi * 11 + m * 3 + si * 4 + mi * 5) % 9 + 1;
                const boost = model === 'LHE' ? 2 : 0;
                const qty = base + boost; // 3..12-ish
                days.forEach((d, di) => {
                  const portion = di === 0 ? 0.40 : di === 1 ? 0.35 : 0.25;
                  const q = Math.max(1, Math.round(qty * portion));
                  tx.push({ date: `${y}-${pad2(m)}-${pad2(d)}`, sale, model, qty: q });
                });
              });
            });
          }
        });
        return tx;
      })();



      // Quotation forklift transactions (mock data) - used for forklift quotation vs service success
      const quoteForkTx = (() => {
        const tx = [];
        const years = [2024, 2025];
        const days = [2, 10, 22];
        years.forEach((y, yi) => {
          for (let m = 1; m <= 12; m++) {
            sales.forEach((sale, si) => {
              forkliftModels.forEach((model, mi) => {
                const base = (yi * 13 + m * 4 + si * 5 + mi * 6) % 10 + 3;
                const boost = model === 'LHE' ? 3 : 0;
                const qty = base + boost; // 6..16-ish (usually >= contracts)
                days.forEach((d, di) => {
                  const portion = di === 0 ? 0.42 : di === 1 ? 0.33 : 0.25;
                  const q = Math.max(1, Math.round(qty * portion));
                  tx.push({ date: `${y}-${pad2(m)}-${pad2(d)}`, sale, model, qty: q });
                });
              });
            });
          }
        });
        return tx;
      })();

    // ========= Section 1: Agent Compare (Summary) =========
      const startEl = document.getElementById('saleStartDate');
      const endEl = document.getElementById('saleEndDate');
      const applyBtn = document.getElementById('saleApplyBtn');
      const resetBtn = document.getElementById('saleResetBtn');
      const saleCanvas = document.getElementById('saleCompareChart');
      const chipsEl = document.getElementById('saleSummaryChips');
      const rangeEl = document.getElementById('saleTableRange');
      const tableBody = document.querySelector('#saleSummaryTable tbody');

      // hidden select used for logic
      const saleSelect = document.getElementById('saleMultiSelect');

      // checkbox dropdown UI
      const saleMultiDropdown = document.getElementById('saleDropdown');
      const saleDropdownBtn = document.getElementById('saleDropdownBtn');
      const saleDropdownPanel = document.getElementById('saleDropdownPanel');
      const saleDropdownList = document.getElementById('saleDropdownList');
      const saleSelectAllBtn = document.getElementById('saleSelectAll');
      const saleClearAllBtn = document.getElementById('saleClearAll');

      function populateHiddenSaleSelect() {
        if (!saleSelect) return;
        saleSelect.innerHTML = '';
        Object.keys(saleMonthly).forEach((name) => {
          const opt = document.createElement('option');
          opt.value = name;
          opt.textContent = name;
          opt.selected = true; // default: all selected
          saleSelect.appendChild(opt);
        });
      }

      function getSelectedSales() {
        return [ACTIVE_AGENT];
      }

      function updateSaleDropdownLabel() {
        if (!saleDropdownBtn || !saleSelect) return;
        const total = saleSelect.options.length;
        const selected = Array.from(saleSelect.options).filter(o => o.selected).length;
        const effective = selected === 0 ? total : selected;
        const label = (effective === total) ? '‡πÄ‡∏•‡∏∑‡∏≠‡∏Å Agent (‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î)' : `‡πÄ‡∏•‡∏∑‡∏≠‡∏Å Agent (${effective} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£)`;
        saleDropdownBtn.innerHTML = `${label} <span class="mdrop-caret">‚ñæ</span>`;
      }

      function initSaleDropdown() {
        if (!saleMultiDropdown || !saleDropdownBtn || !saleDropdownPanel || !saleDropdownList || !saleSelect) return;

        saleDropdownList.innerHTML = '';
        Array.from(saleSelect.options).forEach((opt) => {
          const row = document.createElement('label');
          row.className = 'mdrop-item';

          const cb = document.createElement('input');
          cb.type = 'checkbox';
          cb.checked = !!opt.selected;
          cb.dataset.value = opt.value;

          const txt = document.createElement('span');
          txt.textContent = opt.textContent;

          cb.addEventListener('change', () => {
            const o = Array.from(saleSelect.options).find(x => x.value === cb.dataset.value);
            if (o) o.selected = cb.checked;
            updateSaleDropdownLabel();
            updateSaleCompare();
            updateSaleForkChart(); // keep charts synced
          });

          row.appendChild(cb);
          row.appendChild(txt);
          saleDropdownList.appendChild(row);
        });

        updateSaleDropdownLabel();

        const close = () => {
          saleMultiDropdown.classList.remove('open');
          saleDropdownBtn.setAttribute('aria-expanded', 'false');
        };
        const open = () => {
          saleMultiDropdown.classList.add('open');
          saleDropdownBtn.setAttribute('aria-expanded', 'true');
        };

        saleDropdownBtn.addEventListener('click', (e) => {
          e.preventDefault();
          e.stopPropagation();
          if (saleMultiDropdown.classList.contains('open')) close(); else open();
        });
        saleDropdownPanel.addEventListener('click', (e) => e.stopPropagation());
        document.addEventListener('click', () => close());
        document.addEventListener('keydown', (e) => { if (e.key === 'Escape') close(); });

        if (saleSelectAllBtn) {
          saleSelectAllBtn.addEventListener('click', () => {
            Array.from(saleSelect.options).forEach(o => o.selected = true);
            Array.from(saleDropdownList.querySelectorAll('input[type=checkbox]')).forEach(cb => cb.checked = true);
            updateSaleDropdownLabel();
            updateSaleCompare();
            updateSaleForkChart();
          });
        }
        if (saleClearAllBtn) {
          saleClearAllBtn.addEventListener('click', () => {
            Array.from(saleSelect.options).forEach(o => o.selected = false);
            Array.from(saleDropdownList.querySelectorAll('input[type=checkbox]')).forEach(cb => cb.checked = false);
            updateSaleDropdownLabel();
            updateSaleCompare();
            updateSaleForkChart();
          });
        }
      }

      function sumBySale(saleName, keys) {
        let quotations = 0;
        let services = 0;
        const map = saleMonthly[saleName] || {};
        keys.forEach((k) => {
          const row = map[k];
          if (!row) return;
          const c = row.c || 0;
          const u = row.u || 0;
          quotations += Math.max(c, u);
          services += Math.min(c, u);
        });
        return { sale: saleName, quotations, services };
      }

      
function renderChips(rows) {
  if (!chipsEl) return;
  const totalQ = rows.reduce((a, r) => a + (r.quotations || 0), 0);
  const totalS = rows.reduce((a, r) => a + (r.services || 0), 0);
  const successRate = totalQ ? ((totalS / totalQ) * 100) : 0;

  chipsEl.innerHTML = `
    <div style="padding: 1.05rem 1.15rem; background:#eff6ff; border-radius:12px; border:1px solid #bfdbfe;">
      <div style="font-size:0.85rem; font-weight:800; color:#0f172a; margin-bottom:0.35rem;">
        ‡∏™‡∏£‡∏∏‡∏õ‡∏ä‡πà‡∏ß‡∏á‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å (Agent 1 ‡∏Ñ‡∏ô)
      </div>
      <div style="font-size:1.35rem; font-weight:900; color:var(--primary-color); line-height:1.15;">
        ${totalQ.toLocaleString()} ‡πÉ‡∏ö‡πÄ‡∏™‡∏ô‡∏≠‡∏£‡∏≤‡∏Ñ‡∏≤ / ${totalS.toLocaleString()} ‡∏™‡∏±‡∏ç‡∏ç‡∏≤‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£
      </div>
      <div style="font-size:0.85rem; font-weight:700; color:#334155; margin-top:0.35rem;">
        ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏ï‡∏≤‡∏°‡∏ä‡πà‡∏ß‡∏á‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å
      </div>
    </div>

    <div style="padding: 1.05rem 1.15rem; background:#dcfce7; border-radius:12px; border:1px solid #86efac;">
      <div style="font-size:0.85rem; font-weight:700; color:#065f46; margin-bottom:0.35rem;">
        ‡∏≠‡∏±‡∏ï‡∏£‡∏≤‡∏Å‡∏≤‡∏£‡∏ó‡∏≥‡∏™‡∏±‡∏ç‡∏ç‡∏≤‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à
      </div>
      <div style="font-size:1.55rem; font-weight:900; color:#047857; line-height:1.15;">
        ${successRate.toFixed(1)}%
      </div>
      <div style="font-size:0.95rem; font-weight:800; color:#065f46; margin-top:0.35rem;">
        ‡πÉ‡∏ö‡πÄ‡∏™‡∏ô‡∏≠‡∏£‡∏≤‡∏Ñ‡∏≤ ${totalQ.toLocaleString()} / ‡∏™‡∏±‡∏ç‡∏ç‡∏≤‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£ ${totalS.toLocaleString()}
      </div>
    </div>
  `;
}



      function renderTable(rows, rangeText) {
        if (rangeEl) rangeEl.textContent = rangeText ? `‡∏ä‡πà‡∏ß‡∏á‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà: ${rangeText}` : '';
        if (!tableBody) return;
        const sorted = rows.slice().sort((a, b) => b.quotations - a.quotations);
        tableBody.innerHTML = sorted.map((r, i) => `
          <tr>
            <td style="text-align:center;">${i + 1}</td>
            <td>${r.sale}${i === 0 ? ' üèÜ' : ''}</td>
            <td style="text-align:right;">${r.quotations}</td>
            <td style="text-align:right;">${r.services}</td>
          </tr>
        `).join('');
      }

      let saleChart = null;
      if (saleCanvas && hasChart) {
        saleChart = new Chart(saleCanvas.getContext('2d'), {
          type: 'bar',
          data: {
            labels: [],
            datasets: [
              { label: '‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÉ‡∏ö‡πÄ‡∏™‡∏ô‡∏≠‡∏£‡∏≤‡∏Ñ‡∏≤', data: [], backgroundColor: 'rgba(31, 111, 178, 0.85)', borderWidth: 0 },
              { label: '‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏™‡∏±‡∏ç‡∏ç‡∏≤‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£', data: [], backgroundColor: 'rgba(255, 122, 26, 0.85)', borderWidth: 0 },
            ]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: { legend: { position: 'bottom' }, tooltip: { enabled: true } },
            scales: {
              x: { grid: { display: false } },
              y: { beginAtZero: true, ticks: { precision: 0 } }
            }
          }
        });
      }

      function updateSaleCompare() {
        if (!startEl || !endEl) return;

        const today = new Date();
        const yyyy = today.getFullYear();
        const defaultStart = `${yyyy}-01-01`;
        const defaultEnd = toYMD(today);

        const startVal = startEl.value || defaultStart;
        const endVal = endEl.value || defaultEnd;

        // ‡∏£‡∏≤‡∏¢‡πÄ‡∏î‡∏∑‡∏≠‡∏ô: ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡πÉ‡∏ô‡∏ä‡πà‡∏ß‡∏á‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å
        const keys = monthRangeKeys(startVal, endVal);

        // ‚úÖ Agent ‡∏Ñ‡∏ô‡πÄ‡∏î‡∏µ‡∏¢‡∏ß
        const selected = [ACTIVE_AGENT];

        // Chips + Table (‡∏¢‡∏±‡∏á‡πÉ‡∏ä‡πâ‡πÄ‡∏î‡∏¥‡∏°‡πÑ‡∏î‡πâ ‡πÅ‡∏ï‡πà‡πÄ‡∏´‡∏•‡∏∑‡∏≠ 1 ‡πÅ‡∏ñ‡∏ß)
        const rows = selected.map(s => sumBySale(s, keys));
        renderChips(rows);
        renderTable(rows, formatRange(startVal, endVal));

        // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏™‡πà‡∏ß‡∏ô‡∏™‡∏£‡∏∏‡∏õ‡∏£‡∏ñ‡∏¢‡∏Å (‡πÉ‡∏ä‡πâ Agent ‡∏Ñ‡∏ô‡πÄ‡∏î‡∏µ‡∏¢‡∏ß)
        updateForkliftSummary(startVal, endVal, selected);

        // ‚úÖ ‡∏Å‡∏£‡∏≤‡∏ü: ‡πÅ‡∏ó‡πà‡∏á‡∏£‡∏≤‡∏¢‡πÄ‡∏î‡∏∑‡∏≠‡∏ô (‡πÉ‡∏ö‡πÄ‡∏™‡∏ô‡∏≠‡∏£‡∏≤‡∏Ñ‡∏≤ vs ‡∏™‡∏±‡∏ç‡∏ç‡∏≤‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£) ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö Agent ‡∏Ñ‡∏ô‡πÄ‡∏î‡∏µ‡∏¢‡∏ß
        if (saleChart) {
          const map = saleMonthly[ACTIVE_AGENT] || {};
          const quotationsByMonth = keys.map(k => (map[k]?.c || 0));
          const servicesByMonth = keys.map(k => (map[k]?.u || 0));

          saleChart.data.labels = keys; // ‡πÄ‡∏ä‡πà‡∏ô 2025-01, 2025-02 ...
          saleChart.data.datasets[0].data = quotationsByMonth;
          saleChart.data.datasets[1].data = servicesByMonth;
          saleChart.update();
        }
      }

      // Defaults for summary date range
      (function initSummaryDateDefaults(){
        if (!startEl || !endEl) return;
        const today = new Date();
        const yyyy = today.getFullYear();
        if (!startEl.value) startEl.value = `${yyyy}-01-01`;
        if (!endEl.value) endEl.value = toYMD(today);
      })();

      
      // ========= Section 1.5: Agent Revenue (Monthly) =========
      const revStartEl = document.getElementById('revStartDate');
      const revEndEl = document.getElementById('revEndDate');
      const revApplyBtn = document.getElementById('revApplyBtn');
      const revResetBtn = document.getElementById('revResetBtn');
      const revTotalEl = document.getElementById('revTotalValue');
      const revAvgEl = document.getElementById('revAvgValue');
      const revRangeTextEl = document.getElementById('revRangeText');
      const revCanvas = document.getElementById('agentRevenueChart');

      const fmtTHB = (n) => {
        const v = Number(n || 0);
        return '‡∏ø' + v.toLocaleString('th-TH');
      };

      // Defaults for revenue date range
      (function initRevenueDateDefaults(){
        if (!revStartEl || !revEndEl) return;
        const today = new Date();
        const yyyy = today.getFullYear();
        if (!revStartEl.value) revStartEl.value = `${yyyy}-01-01`;
        if (!revEndEl.value) revEndEl.value = toYMD(today);
      })();

      let revenueChart = null;
      if (revCanvas && hasChart) {
        revenueChart = new Chart(revCanvas.getContext('2d'), {
          type: 'bar',
          data: {
            labels: [],
            datasets: [
              {
                label: '‡∏£‡∏≤‡∏¢‡πÑ‡∏î‡πâ (‡∏ö‡∏≤‡∏ó)',
                data: [],
                borderWidth: 0,
                backgroundColor: 'rgba(255, 122, 26, 0.88)'
              }
            ]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
              legend: { position: 'bottom' },
              tooltip: {
                callbacks: {
                  label: (ctx) => ` ${fmtTHB(ctx.parsed.y)}`
                }
              }
            },
            scales: {
              x: { grid: { display: false } },
              y: {
                beginAtZero: true,
                ticks: {
                  callback: (value) => {
                    // shorten large numbers: 1000000 -> 1,000,000
                    return Number(value).toLocaleString('th-TH');
                  }
                }
              }
            }
          }
        });
      }

      function updateRevenueChart() {
        if (!revStartEl || !revEndEl) return;

        const today = new Date();
        const yyyy = today.getFullYear();
        const defaultStart = `${yyyy}-01-01`;
        const defaultEnd = toYMD(today);

        const startVal = revStartEl.value || defaultStart;
        const endVal = revEndEl.value || defaultEnd;

        const keys = monthRangeKeys(startVal, endVal);
        const map = (revenueMonthly && revenueMonthly[ACTIVE_AGENT]) ? revenueMonthly[ACTIVE_AGENT] : {};

        const values = keys.map(k => Number(map[k] || 0));
        const total = values.reduce((a, b) => a + b, 0);
        const avg = keys.length ? Math.round(total / keys.length) : 0;

        if (revTotalEl) revTotalEl.textContent = fmtTHB(total);
        if (revAvgEl) revAvgEl.textContent = fmtTHB(avg);
        if (revRangeTextEl) revRangeTextEl.textContent = keys.length ? `‡∏ä‡πà‡∏ß‡∏á‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà: ${formatRange(startVal, endVal)}` : '‚Äî';

        if (revenueChart) {
          revenueChart.data.labels = keys;
          revenueChart.data.datasets[0].data = values;
          revenueChart.update();
        }
      }

      if (revApplyBtn) revApplyBtn.addEventListener('click', updateRevenueChart);
      if (revResetBtn) revResetBtn.addEventListener('click', () => {
        const today = new Date();
        const yyyy = today.getFullYear();
        if (revStartEl) revStartEl.value = `${yyyy}-01-01`;
        if (revEndEl) revEndEl.value = toYMD(today);
        updateRevenueChart();
      });
      if (revStartEl) revStartEl.addEventListener('change', updateRevenueChart);
      if (revEndEl) revEndEl.addEventListener('change', updateRevenueChart);

      // First render
      updateRevenueChart();


// ========= Section 2: Model chart (month/year) =========
      const modelCanvas = document.getElementById('modelHoursChart');
      const modelStartEl = document.getElementById('modelStartDate');
      const modelEndEl = document.getElementById('modelEndDate'); 

      
      function getModelSeriesByRange(startDate, endDate) {
        const sTime = Math.min(startDate.getTime(), endDate.getTime());
        const eTime = Math.max(startDate.getTime(), endDate.getTime());

        const sumContracts = { LHE: 0, LPE: 0, RRE: 0 };
        const sumQuotes = { LHE: 0, LPE: 0, RRE: 0 };

        // ‚úÖ Contract units (‡∏ó‡∏≥‡∏™‡∏±‡∏ç‡∏ç‡∏≤) - Agent ‡∏Ñ‡∏ô‡πÄ‡∏î‡∏µ‡∏¢‡∏ß
        saleForkTx.forEach((t) => {
          if (t.sale && t.sale !== ACTIVE_AGENT) return;
          const d = new Date(t.date);
          const tt = d.getTime();
          if (tt < sTime || tt > eTime) return;
          if (sumContracts[t.model] != null) sumContracts[t.model] += (+t.qty || 0);
        });

        // ‚úÖ Quotation units (‡πÉ‡∏ö‡πÄ‡∏™‡∏ô‡∏≠‡∏£‡∏≤‡∏Ñ‡∏≤) - Agent ‡∏Ñ‡∏ô‡πÄ‡∏î‡∏µ‡∏¢‡∏ß
        quoteForkTx.forEach((t) => {
          if (t.sale && t.sale !== ACTIVE_AGENT) return;
          const d = new Date(t.date);
          const tt = d.getTime();
          if (tt < sTime || tt > eTime) return;
          if (sumQuotes[t.model] != null) sumQuotes[t.model] += (+t.qty || 0);
        });

        return {
          labels: ['LHE','LPE','RRE'],
          contractValues: [sumContracts.LHE, sumContracts.LPE, sumContracts.RRE],
          quoteValues: [sumQuotes.LHE, sumQuotes.LPE, sumQuotes.RRE]
        };
      }


      
      let modelChart = null;
      if (modelCanvas && hasChart) {
        modelChart = new Chart(modelCanvas.getContext('2d'), {
          type: 'bar',
          data: {
            labels: ['LHE','LPE','RRE'],
            datasets: [
              {
                label: 'Unit ‡∏ó‡∏≥‡∏™‡∏±‡∏ç‡∏ç‡∏≤',
                data: [0,0,0],
                borderWidth: 0,
                backgroundColor: 'rgba(31, 111, 178, 0.85)'
              },
              {
                label: 'Unit ‡πÉ‡∏ö‡πÄ‡∏™‡∏ô‡∏≠‡∏£‡∏≤‡∏Ñ‡∏≤',
                data: [0,0,0],
                borderWidth: 0,
                backgroundColor: 'rgba(255, 122, 26, 0.85)'
              }
            ]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            indexAxis: 'y',
            plugins: { legend: { position: 'bottom' }, tooltip: { enabled: true } },
            scales: {
              x: { beginAtZero: true, ticks: { precision: 0 } },
              y: { grid: { display: false } }
            }
          }
        });
      }


      function updateModelChart() {
        if (!modelChart) return;

        // Default: first day of current month -> today
        const today = new Date();
        const defaultStart = new Date(today.getFullYear(), today.getMonth(), 1);

        const s = safeDate(modelStartEl && modelStartEl.value) || defaultStart;
        const e = safeDate(modelEndEl && modelEndEl.value) || today;

        const series = getModelSeriesByRange(s, e);
        modelChart.data.labels = series.labels;
        modelChart.data.datasets[0].data = series.contractValues;
        modelChart.data.datasets[1].data = series.quoteValues;
        modelChart.update();
      }

      // init default values so chart isn't empty
      (function initModelDateDefaults(){
        const today = new Date();
        const start = new Date(today.getFullYear(), today.getMonth(), 1);
        if (modelStartEl && !modelStartEl.value) modelStartEl.value = toYMD(start);
        if (modelEndEl && !modelEndEl.value) modelEndEl.value = toYMD(today);
      })();

      if (modelStartEl) modelStartEl.addEventListener('change', updateModelChart);
      if (modelEndEl) modelEndEl.addEventListener('change', updateModelChart);
      updateModelChart();

      // ========= Section 3: Forklifts per Agent (stacked by model) =========
      const sfStartEl = document.getElementById('saleForkStartDate');
      const sfEndEl = document.getElementById('saleForkEndDate');
      const sfModeEl = document.getElementById('saleForkSaleFilter');
      const saleForkCanvas = document.getElementById('saleForkliftChart');

      // Add individual sale options into sfModeEl (so user can pick 1 sale)
      function ensureSaleOptionsInForkFilter() {
        if (!sfModeEl) return;
        const existing = new Set(Array.from(sfModeEl.options).map(o => o.value));
        sales.forEach((s) => {
          if (existing.has(s)) return;
          const opt = document.createElement('option');
          opt.value = s;
          opt.textContent = s;
          sfModeEl.appendChild(opt);
        });
      }

      let saleForkChart = null;
      // Pie chart (solid) + value labels inside slices
      const valueLabelsPlugin = {
        id: 'valueLabelsPlugin',
        afterDatasetsDraw(chart) {
          const { ctx } = chart;
          ctx.save();
          const meta = chart.getDatasetMeta(0);
          const data = chart.data.datasets[0].data || [];
          meta.data.forEach((arc, i) => {
            const v = data[i];
            if (!v) return;
            const p = arc.tooltipPosition();
            ctx.fillStyle = '#ffffff';
            ctx.font = '700 14px Prompt, sans-serif';
            ctx.textAlign = 'center';
            ctx.textBaseline = 'middle';
            ctx.fillText(String(v), p.x, p.y);
          });
          ctx.restore();
        }
      };

      if (saleForkCanvas && hasChart) {
        saleForkChart = new Chart(saleForkCanvas.getContext('2d'), {
          type: 'pie',
          data: {
            labels: ['RRE','LPE','LHE'],
            datasets: [
              {
                label: '‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏£‡∏ñ‡∏¢‡∏Å‡∏ó‡∏µ‡πà‡∏ó‡∏≥‡∏™‡∏±‡∏ç‡∏ç‡∏≤',
                data: [0, 0, 0],
                backgroundColor: ['#1F6FB2', '#FF7A1A', '#16A34A'],
                borderColor: '#ffffff',
                borderWidth: 3
              }
            ]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
              legend: { position: 'bottom' },
              tooltip: { enabled: true }
            }
          },
          plugins: [valueLabelsPlugin]
        });
      }

function getSalesForForkChart() {
        return [ACTIVE_AGENT];
      }

      function updateSaleForkChart() {
        if (!saleForkChart) return;

        const today = new Date();
        const defaultStart = new Date(today.getFullYear(), today.getMonth(), 1);

        const s = safeDate(sfStartEl && sfStartEl.value) || defaultStart;
        const e = safeDate(sfEndEl && sfEndEl.value) || today;

        const sTime = Math.min(s.getTime(), e.getTime());
        const eTime = Math.max(s.getTime(), e.getTime());

        const saleName = (typeof ACTIVE_AGENT !== 'undefined' && ACTIVE_AGENT) ? ACTIVE_AGENT : (sales && sales[0]) || '';
        const agg = { LHE: 0, LPE: 0, RRE: 0 };

        saleForkTx.forEach((item) => {
          if (saleName && item.sale !== saleName) return;
          const d = new Date(item.date);
          const t = d.getTime();
          if (t < sTime || t > eTime) return;
          if (!agg[item.model]) agg[item.model] = 0;
          agg[item.model] += (+item.qty || 0);
        });

        saleForkChart.data.labels = ['RRE','LPE','LHE'];
        saleForkChart.data.datasets[0].data = [agg.RRE || 0, agg.LPE || 0, agg.LHE || 0];
        saleForkChart.update();
}

      // Defaults for forklift chart date range
      (function initForkDateDefaults(){
        if (sfStartEl && !sfStartEl.value) {
          const today = new Date();
          const start = new Date(today.getFullYear(), today.getMonth(), 1);
          sfStartEl.value = toYMD(start);
        }
        if (sfEndEl && !sfEndEl.value) sfEndEl.value = toYMD(new Date());
      })();

      if (sfStartEl) sfStartEl.addEventListener('change', updateSaleForkChart);
      if (sfEndEl) sfEndEl.addEventListener('change', updateSaleForkChart);
      if (sfModeEl) sfModeEl.addEventListener('change', updateSaleForkChart);

      // ========= Wire main buttons =========
      if (applyBtn) applyBtn.addEventListener('click', () => {
        updateSaleCompare();
        updateSaleForkChart();
        // Monthly forklift quotation vs contract chart
        updateForkliftCompareChart(startEl && startEl.value, endEl && endEl.value);
      });
      if (resetBtn) resetBtn.addEventListener('click', () => {
        const today = new Date();
        const yyyy = today.getFullYear();
        if (startEl) startEl.value = `${yyyy}-01-01`;
        if (endEl) endEl.value = toYMD(today);

        if (saleSelect) Array.from(saleSelect.options).forEach(o => o.selected = true);
        if (saleDropdownList) Array.from(saleDropdownList.querySelectorAll('input[type=checkbox]')).forEach(cb => cb.checked = true);
        updateSaleDropdownLabel();

        // reset forklift filter to follow main
        if (sfModeEl) sfModeEl.value = '__use_main__';

        updateSaleCompare();
        updateSaleForkChart();
      });

      // ========= Init everything =========
      populateHiddenSaleSelect();
      initSaleDropdown();

    // ---------- Forklift Filters (date range + multi-select) ----------
    const forkliftStartEl = document.getElementById('forkliftStartDate');
    const forkliftEndEl = document.getElementById('forkliftEndDate');
    const forkliftSelect = document.getElementById('forkliftMultiSelect');

    const forkliftMultiDropdown = document.getElementById('forkliftDropdown');
    const forkliftDropdownBtn = document.getElementById('forkliftDropdownBtn');
    const forkliftDropdownPanel = document.getElementById('forkliftDropdownPanel');
    const forkliftDropdownList = document.getElementById('forkliftDropdownList');
    const forkliftSelectAllBtn = document.getElementById('forkliftSelectAllBtn');
    const forkliftClearBtn = document.getElementById('forkliftClearBtn');

    const forkliftUpdateBtn = document.getElementById('forkliftUpdateBtn');
    const forkliftResetBtn = document.getElementById('forkliftResetBtn');

    function getSelectedForkliftNames() {
      if (!forkliftDropdownList) return [];
      return Array.from(forkliftDropdownList.querySelectorAll('input[type=checkbox]:checked')).map(cb => cb.value);
    }

    function setForkliftBtnLabel() {
      if (!forkliftDropdownBtn) return;
      const selected = getSelectedForkliftNames();
      const total = (sales || []).length;
      let text = `‡πÄ‡∏•‡∏∑‡∏≠‡∏Å Sale`;
      if (!selected.length || selected.length === total) text = `‡πÄ‡∏•‡∏∑‡∏≠‡∏Å Agent (‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î)`;
      else if (selected.length === 1) text = selected[0];
      else text = `${selected.length} ‡∏Ñ‡∏ô`;
      forkliftDropdownBtn.innerHTML = `${text} <span class="mdrop-caret">‚ñæ</span>`;
    }

    function initForkliftDropdown() {
      if (!forkliftMultiDropdown || !forkliftDropdownBtn || !forkliftDropdownPanel || !forkliftDropdownList || !forkliftSelect) return;

      // seed dates from main filter (if any)
      if (forkliftStartEl && startEl && startEl.value) forkliftStartEl.value = startEl.value;
      if (forkliftEndEl && endEl && endEl.value) forkliftEndEl.value = endEl.value;

      forkliftSelect.innerHTML = '';
      forkliftDropdownList.innerHTML = '';

      (sales || []).forEach((name) => {
        const opt = document.createElement('option');
        opt.value = name;
        opt.textContent = name;
        opt.selected = true;
        forkliftSelect.appendChild(opt);

        const row = document.createElement('label');
        row.className = 'mdrop-item';
        row.innerHTML = `<input type="checkbox" checked value="${name}" /> <span>${name}</span>`;
        forkliftDropdownList.appendChild(row);
      });

      setForkliftBtnLabel();

      const close = () => {
        forkliftMultiDropdown.classList.remove('open');
        forkliftDropdownBtn.setAttribute('aria-expanded', 'false');
      };
      const open = () => {
        forkliftMultiDropdown.classList.add('open');
        forkliftDropdownBtn.setAttribute('aria-expanded', 'true');
      };

      forkliftDropdownBtn.addEventListener('click', (e) => {
        e.stopPropagation();
        forkliftMultiDropdown.classList.contains('open') ? close() : open();
      });
      forkliftDropdownPanel.addEventListener('click', (e) => e.stopPropagation());
      document.addEventListener('click', () => close());

      forkliftDropdownList.addEventListener('change', () => setForkliftBtnLabel());

      if (forkliftSelectAllBtn) forkliftSelectAllBtn.addEventListener('click', () => {
        Array.from(forkliftDropdownList.querySelectorAll('input[type=checkbox]')).forEach(cb => cb.checked = true);
        setForkliftBtnLabel();
      });
      if (forkliftClearBtn) forkliftClearBtn.addEventListener('click', () => {
        Array.from(forkliftDropdownList.querySelectorAll('input[type=checkbox]')).forEach(cb => cb.checked = false);
        setForkliftBtnLabel();
      });

      const runUpdate = () => {
        const s = forkliftStartEl ? forkliftStartEl.value : '';
        const e = forkliftEndEl ? forkliftEndEl.value : '';
        const sel = getSelectedForkliftNames();
        if (typeof updateForkliftSummary === 'function') updateForkliftSummary(s, e, sel);
        if (typeof updateForkliftCompareChart === 'function') updateForkliftCompareChart(s, e);
      };

      if (forkliftUpdateBtn) forkliftUpdateBtn.addEventListener('click', runUpdate);

      if (forkliftResetBtn) forkliftResetBtn.addEventListener('click', () => {
        if (forkliftStartEl) forkliftStartEl.value = '';
        if (forkliftEndEl) forkliftEndEl.value = '';
        Array.from(forkliftDropdownList.querySelectorAll('input[type=checkbox]')).forEach(cb => cb.checked = true);
        setForkliftBtnLabel();
        runUpdate();
      });

      // first run
      runUpdate();
    }

    initForkliftDropdown();
      ensureSaleOptionsInForkFilter();

      updateSaleCompare();
      updateModelChart();
      updateSaleForkChart();

      // --- Forklift quotation vs service summary (uses quoteForkTx vs saleForkTx) ---
      function inRangeISO(dateStr, startStr, endStr) {
        if (!dateStr) return false;
        if (startStr && dateStr < startStr) return false;
        if (endStr && dateStr > endStr) return false;
        return true;
      }

      function sumForkliftsBySale(saleName, startStr, endStr) {
        let qFork = 0;
        let sFork = 0;

        quoteForkTx.forEach((t) => {
          if (t.sale !== saleName) return;
          if (!inRangeISO(t.date, startStr, endStr)) return;
          qFork += (+t.qty || 0);
        });

        saleForkTx.forEach((t) => {
          if (t.sale !== saleName) return;
          if (!inRangeISO(t.date, startStr, endStr)) return;
          sFork += (+t.qty || 0);
        });

        return { sale: saleName, qFork, sFork };
      }

      
function renderForkliftChips(rows) {
  const el = document.getElementById('forkliftSummaryChips');
  if (!el) return;

  const totalQ = rows.reduce((a, r) => a + (r.qFork || 0), 0);
  const totalS = rows.reduce((a, r) => a + (r.sFork || 0), 0);
  const successRate = totalQ ? ((totalS / totalQ) * 100) : 0;

  el.innerHTML = `
    <div style="padding: 1.05rem 1.15rem; background:#f9fbff; border-radius:12px; border:1px solid #e5edf8;">
      <div style="font-size:0.85rem; font-weight:700; color:#0f172a; margin-bottom:0.35rem;">
        ‡∏™‡∏£‡∏∏‡∏õ‡∏ä‡πà‡∏ß‡∏á‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å (Agent 1 ‡∏Ñ‡∏ô)
      </div>
      <div style="font-size:1.35rem; font-weight:900; color:var(--primary-color); line-height:1.15;">
        ‡∏£‡∏ñ‡πÉ‡∏ô‡πÉ‡∏ö‡πÄ‡∏™‡∏ô‡∏≠‡∏£‡∏≤‡∏Ñ‡∏≤ ${totalQ.toLocaleString()} / ‡∏£‡∏ñ‡πÉ‡∏ô‡∏™‡∏±‡∏ç‡∏ç‡∏≤ ${totalS.toLocaleString()}
      </div>
      <div style="font-size:0.85rem; color:var(--muted-text); margin-top:0.35rem;">
        ‡πÄ‡∏õ‡∏£‡∏µ‡∏¢‡∏ö‡πÄ‡∏ó‡∏µ‡∏¢‡∏ö‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏£‡∏ñ‡∏¢‡∏Å‡∏ï‡∏≤‡∏°‡∏ä‡πà‡∏ß‡∏á‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å
      </div>
    </div>

    <div style="padding: 1.05rem 1.15rem; background:#dcfce7; border-radius:12px; border:1px solid #86efac;">
      <div style="font-size:0.85rem; font-weight:700; color:#065f46; margin-bottom:0.35rem;">
        ‡∏≠‡∏±‡∏ï‡∏£‡∏≤‡∏Å‡∏≤‡∏£‡∏ó‡∏≥‡∏™‡∏±‡∏ç‡∏ç‡∏≤‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à
      </div>
      <div style="font-size:1.55rem; font-weight:900; color:#047857; line-height:1.15;">
        ${successRate.toFixed(1)}%
      </div>
      <div style="font-size:0.95rem; font-weight:800; color:#065f46; margin-top:0.35rem;">
        ‡∏£‡∏ñ‡πÉ‡∏ô‡πÉ‡∏ö‡πÄ‡∏™‡∏ô‡∏≠‡∏£‡∏≤‡∏Ñ‡∏≤ ${totalQ.toLocaleString()} / ‡∏£‡∏ñ‡πÉ‡∏ô‡∏™‡∏±‡∏ç‡∏ç‡∏≤ ${totalS.toLocaleString()}
      </div>
    </div>
  `;
}



  function renderForkliftTable(rows) {
        const tbody = document.getElementById('forkliftSummaryTbody');
        if (!tbody) return;

        const sorted = rows.slice().sort((a, b) => (b.sFork - a.sFork) || (b.qFork - a.qFork));
        tbody.innerHTML = sorted.map((r, i) => {
          const rate = r.qFork ? ((r.sFork / r.qFork) * 100) : 0;
          return `
            <tr>
              <td style="text-align:center;">${i + 1}</td>
              <td style="font-weight:700;">${r.sale}</td>
              <td style="text-align:right;">${r.qFork.toLocaleString()}</td>
              <td style="text-align:right;">${r.sFork.toLocaleString()}</td>
              <td style="text-align:right; font-weight:800; color:var(--primary-color);">${rate.toFixed(1)}%</td>
            </tr>
          `;
        }).join('');
      }
      // ---------- Forklift compare chart (Quotation vs Service) : Monthly ----------
      var forkliftCompareCanvas = document.getElementById('forkliftCompareChart');
      var forkliftCompareChart = null;

      // Sum qty by month for a sale in a time range
      function sumForkQtyByMonthInRange(tx, saleName, startTime, endTime) {
        const map = {};
        (tx || []).forEach((r) => {
          if (!r || r.sale !== saleName) return;
          const d = safeDate(r.date);
          if (!d) return;
          const t = d.getTime();
          if (t < startTime || t > endTime) return;
          const k = monthKey(d);
          map[k] = (map[k] || 0) + (Number(r.qty) || 0);
        });
        return map;
      }

      if (forkliftCompareCanvas && hasChart) {
        forkliftCompareChart = new Chart(forkliftCompareCanvas.getContext('2d'), {
          type: 'bar',
          data: {
            labels: [],
            datasets: [
              { label: '‡∏£‡∏ñ‡∏¢‡∏Å‡πÉ‡∏ô‡πÉ‡∏ö‡πÄ‡∏™‡∏ô‡∏≠‡∏£‡∏≤‡∏Ñ‡∏≤', data: [], backgroundColor: 'rgba(31, 111, 178, 0.85)', borderWidth: 0 },
              { label: '‡∏£‡∏ñ‡∏¢‡∏Å‡πÉ‡∏ô‡∏™‡∏±‡∏ç‡∏ç‡∏≤‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£', data: [], backgroundColor: 'rgba(255, 122, 26, 0.85)', borderWidth: 0 }
            ]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: { legend: { display: true, position: 'bottom' }, tooltip: { enabled: true } },
            scales: {
              x: { ticks: { maxRotation: 0 }, grid: { display: false } },
              y: { beginAtZero: true, ticks: { precision: 0 } }
            }
          }
        });
      }

            function renderForkliftCompareFallback(qTotal, sTotal) {
        const host = document.getElementById('forkliftCompareFallback');
        if (!host) return;

        const q = Number(qTotal) || 0;
        const s = Number(sTotal) || 0;
        const max = Math.max(q, s, 1);

        const qPct = Math.round((q / max) * 100);
        const sPct = Math.round((s / max) * 100);

        host.innerHTML = `
          <div class="chart-bars" style="height:180px; justify-content:flex-start; gap:2.0rem;">
            <div class="chart-bar-col" style="flex:0 0 72px;">
              <div class="chart-value">${q.toLocaleString()}</div>
              <div class="chart-bar-outer" style="max-width:44px;">
                <div class="chart-bar contracts" style="height:${qPct}%;"></div>
              </div>
              <div class="chart-label" style="width:72px;">‡∏£‡∏ñ‡∏¢‡∏Å‡πÉ‡∏ö‡πÄ‡∏™‡∏ô‡∏≠‡∏£‡∏≤‡∏Ñ‡∏≤</div>
            </div>

            <div class="chart-bar-col" style="flex:0 0 72px;">
              <div class="chart-value">${s.toLocaleString()}</div>
              <div class="chart-bar-outer" style="max-width:44px;">
                <div class="chart-bar revenue" style="height:${sPct}%;"></div>
              </div>
              <div class="chart-label" style="width:72px;">‡∏£‡∏ñ‡∏¢‡∏Å‡∏™‡∏±‡∏ç‡∏ç‡∏≤</div>
            </div>
          </div>
        `;
      }
      function sumForkQtyBySaleInRange(tx, sale, sTime, eTime) {
        let total = 0;
        tx.forEach((item) => {
          if (item.sale !== sale) return;
          const t = new Date(item.date).getTime();
          if (t < sTime || t > eTime) return;
          total += (+item.qty || 0);
        });
        return total;
      }

      function updateForkliftCompareChart(startStr, endStr) {
        const s = safeDate(startStr) || safeDate((forkliftStartEl && forkliftStartEl.value)) || new Date(new Date().getFullYear(), 0, 1);
        const e = safeDate(endStr) || safeDate((forkliftEndEl && forkliftEndEl.value)) || new Date();
        const sTime = Math.min(s.getTime(), e.getTime());
        const eTime = Math.max(s.getTime(), e.getTime());

        const months = monthRangeKeys(toYMD(s), toYMD(e));
        const saleName = (typeof ACTIVE_AGENT !== 'undefined' && ACTIVE_AGENT) ? ACTIVE_AGENT : (sales && sales[0]);

        const qMap = sumForkQtyByMonthInRange(quoteForkTx, saleName, sTime, eTime);
        const sMap = sumForkQtyByMonthInRange(saleForkTx, saleName, sTime, eTime);

        const qData = months.map((k) => Number(qMap[k] || 0));
        const sData = months.map((k) => Number(sMap[k] || 0));

        const qTotal = qData.reduce((a, b) => a + (Number(b) || 0), 0);
        const sTotal = sData.reduce((a, b) => a + (Number(b) || 0), 0);

        const fallbackHost = document.getElementById('forkliftCompareFallback');

        if (forkliftCompareChart && typeof forkliftCompareChart.update === 'function') {
          if (fallbackHost) fallbackHost.style.display = 'none';
          if (forkliftCompareCanvas) forkliftCompareCanvas.style.display = 'block';

          forkliftCompareChart.data.labels = months;
          forkliftCompareChart.data.datasets[0].data = qData;
          forkliftCompareChart.data.datasets[1].data = sData;
          forkliftCompareChart.update();
        } else {
          if (fallbackHost) fallbackHost.style.display = 'block';
          if (forkliftCompareCanvas) forkliftCompareCanvas.style.display = 'none';
          renderForkliftCompareFallback(qTotal, sTotal);
        }
      }




      function updateForkliftSummary(startStr, endStr, selectedSales) {
        const names = (selectedSales && selectedSales.length) ? selectedSales : Object.keys(saleMonthly);
        const rows = names.map((name) => sumForkliftsBySale(name, startStr, endStr));
        renderForkliftChips(rows);
        renderForkliftTable(rows);
      }
      // init forklift summary + forklift compare chart once
      try {
        const s0 = startEl && startEl.value;
        const e0 = endEl && endEl.value;
        const selected0 = (typeof getSelectedSales === 'function') ? getSelectedSales() : (typeof getSelectedAgents === 'function' ? getSelectedAgents() : []);
        if (typeof updateForkliftSummary === 'function') updateForkliftSummary(s0, e0, selected0);
        if (typeof updateForkliftCompareChart === 'function') updateForkliftCompareChart(s0, e0);
      } catch (e) { console.error(e); }
  });
});
</script>
<script>
document.addEventListener('DOMContentLoaded', function () {
  const dropdowns = document.querySelectorAll('.sale-dropdown');

  dropdowns.forEach(dropdown => {
    const btn = dropdown.querySelector('.sale-toggle-btn');
    const menu = dropdown.querySelector('.sale-dropdown-menu');

    if (!btn || !menu) return;

    btn.addEventListener('click', function (e) {
      e.stopPropagation();

      // close other dropdowns first
      dropdowns.forEach(d => {
        if (d !== dropdown) d.classList.remove('open');
      });

      dropdown.classList.toggle('open');
    });
  });

  // click outside -> close all
  document.addEventListener('click', function () {
    dropdowns.forEach(d => d.classList.remove('open'));
  });
});
</script>
</div>
<script>
  // Sync header label with ACTIVE_AGENT if present
  document.addEventListener('DOMContentLoaded', () => {
    try{
      if (typeof ACTIVE_AGENT !== 'undefined') {
        const el = document.getElementById('activeSaleLabel');
        if (el) el.textContent = 'Sale: ' + ACTIVE_AGENT;
      }
    }catch (e) { console.error(e); }
  // ========= Agent Performance (single agent, forecast) =========
  const apStart = document.getElementById('agentPerfStartDate');
  const apEnd = document.getElementById('agentPerfEndDate');
  const apApply = document.getElementById('agentPerfApplyBtn');
  const apReset = document.getElementById('agentPerfResetBtn');
  const apCards = document.getElementById('agentPerfCards');
  const apCanvas = document.getElementById('agentForecastChart');

  let agentForecastChart;

  // helpers
  function pad2(n){ return String(n).padStart(2,'0'); }

  function monthRangeKeys(startDateStr, endDateStr){
    // returns [YYYY-MM, ...] inclusive between start and end
    const s = new Date(startDateStr);
    const e = new Date(endDateStr);
    if (isNaN(s.getTime()) || isNaN(e.getTime())) return [];
    const start = new Date(s.getFullYear(), s.getMonth(), 1);
    const end = new Date(e.getFullYear(), e.getMonth(), 1);
    const out = [];
    const cur = new Date(start);
    while (cur <= end){
      out.push(`${cur.getFullYear()}-${pad2(cur.getMonth()+1)}`);
      cur.setMonth(cur.getMonth()+1);
    }
    return out;
  }

  function addMonths(ym, add) {
    const [y, m] = ym.split('-').map(Number);
    const d = new Date(y, m - 1, 1);
    d.setMonth(d.getMonth() + add);
    return `${d.getFullYear()}-${pad2(d.getMonth() + 1)}`;
  }

  function buildMonthlyServices(startDateStr, endDateStr) {
    const months = monthRangeKeys(startDateStr, endDateStr);
    const map = (saleMonthly && saleMonthly[ACTIVE_AGENT]) ? saleMonthly[ACTIVE_AGENT] : {};
    const services = months.map(k => (map[k]?.u || 0));
    const quotations = months.map(k => (map[k]?.c || 0));
    return { months, services, quotations };
  }

  function forecastNextValues(actual, n = 3, horizon = 3) {
    const tail = actual.slice(-n).filter(v => typeof v === 'number');
    const avg = tail.length ? (tail.reduce((a,b)=>a+b,0) / tail.length) : 0;
    const base = Math.max(0, Math.round(avg * 10) / 10);
    return Array.from({length: horizon}, (_, i) => Math.max(0, Math.round((base + i * 0.2) * 10) / 10));
  }

  function renderAgentPerfCards(totalQ, totalS, monthsCount, forecastSum) {
    if (!apCards) return;
    const rate = totalQ ? ((totalS / totalQ) * 100) : 0;
    const avg = monthsCount ? (totalS / monthsCount) : 0;

    apCards.innerHTML = `
      <div style="padding: 0.9rem 1rem; background:#f9fbff; border-radius:12px; border:1px solid #e5edf8;">
        <div style="font-size:0.78rem; color:#64748b; margin-bottom:0.25rem;">‡∏™‡∏±‡∏ç‡∏ç‡∏≤‡∏ó‡∏µ‡πà‡∏ó‡∏≥‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à (‡∏ä‡πà‡∏ß‡∏á‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å)</div>
        <div style="font-size:1.35rem; font-weight:800; color:var(--primary-color);">${totalS} ‡∏™‡∏±‡∏ç‡∏ç‡∏≤</div>
        <div style="font-size:0.78rem; color:#64748b;">‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢ ~ ${avg.toFixed(1)} ‡∏™‡∏±‡∏ç‡∏ç‡∏≤/‡πÄ‡∏î‡∏∑‡∏≠‡∏ô</div>
      </div>

      <div style="padding: 0.9rem 1rem; background:#ecfdf5; border-radius:12px; border:1px solid #a7f3d0;">
        <div style="font-size:0.78rem; color:#047857; margin-bottom:0.25rem;">‡∏≠‡∏±‡∏ï‡∏£‡∏≤‡∏Å‡∏≤‡∏£‡∏ó‡∏≥‡∏™‡∏±‡∏ç‡∏ç‡∏≤‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à</div>
        <div style="font-size:1.35rem; font-weight:800; color:#047857;">${rate.toFixed(1)}%</div>
        <div style="font-size:0.78rem; color:#047857;">‡πÉ‡∏ö‡πÄ‡∏™‡∏ô‡∏≠‡∏£‡∏≤‡∏Ñ‡∏≤ ${totalQ} / ‡∏™‡∏±‡∏ç‡∏ç‡∏≤ ${totalS}</div>
      </div>

      <div style="padding: 0.9rem 1rem; background:#fff7e6; border-radius:12px; border:1px solid #fed7aa;">
        <div style="font-size:0.78rem; color:#92400e; margin-bottom:0.25rem;">‡πÅ‡∏ô‡∏ß‡πÇ‡∏ô‡πâ‡∏° (‡∏Ñ‡∏≤‡∏î‡∏Å‡∏≤‡∏£‡∏ì‡πå 3 ‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏ñ‡∏±‡∏î‡πÑ‡∏õ)</div>
        <div style="font-size:1.35rem; font-weight:800; color:#b45309;">‚âà ${forecastSum.toFixed(1)} ‡∏™‡∏±‡∏ç‡∏ç‡∏≤</div>
        <div style="font-size:0.78rem; color:#92400e;">‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ô‡∏à‡∏≤‡∏Å‡∏Ñ‡πà‡∏≤‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢ 3 ‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î</div>
      </div>
    `;
  }

  function renderAgentForecastChart(startDateStr, endDateStr) {
    if (!apCanvas || !window.Chart) return;

    const { months, services, quotations } = buildMonthlyServices(startDateStr, endDateStr);
    const forecast = forecastNextValues(services, 3, 3);
    const futureMonths = forecast.map((_, i) => addMonths(months[months.length - 1] || '2025-01', i + 1));
    const labels = months.concat(futureMonths);

    const barActual = services.concat(Array(forecast.length).fill(null));
    const lineForecast = Array(services.length).fill(null).concat(forecast);

    const totalQ = quotations.reduce((a,b)=>a+(+b||0),0);
    const totalS = services.reduce((a,b)=>a+(+b||0),0);
    const forecastSum = forecast.reduce((a,b)=>a+(+b||0),0);

    renderAgentPerfCards(totalQ, totalS, months.length, forecastSum);

    if (agentForecastChart) agentForecastChart.destroy();

    agentForecastChart = new Chart(apCanvas, {
      type: 'bar',
      data: {
        labels,
        datasets: [
          {
            label: '‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏™‡∏±‡∏ç‡∏ç‡∏≤‡∏ó‡∏µ‡πà‡∏ó‡∏≥‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à (‡∏à‡∏£‡∏¥‡∏á)',
            data: barActual,
            backgroundColor: '#1F6FB2'
          },
          {
            type: 'line',
            label: '‡∏Ñ‡∏≤‡∏î‡∏Å‡∏≤‡∏£‡∏ì‡πå (3 ‡πÄ‡∏î‡∏∑‡∏≠‡∏ô)',
            data: lineForecast,
            borderColor: '#FF7A1A',
            backgroundColor: 'rgba(255,122,26,0.12)',
            borderWidth: 3,
            pointRadius: 3,
            tension: 0.35
          }
        ]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: { legend: { position: 'bottom' } },
        scales: {
          x: { title: { display: true, text: '‡πÄ‡∏î‡∏∑‡∏≠‡∏ô' } },
          y: { beginAtZero: true, title: { display: true, text: '‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏™‡∏±‡∏ç‡∏ç‡∏≤' } }
        }
      }
    });
  }

  // init default dates (sync with other sections if exists)
  try {
    const defStart = (document.getElementById('saleStartDate')?.value) || '2025-01-01';
    const defEnd = (document.getElementById('saleEndDate')?.value) || '2025-12-26';
    if (apStart) apStart.value = defStart;
    if (apEnd) apEnd.value = defEnd;

    renderAgentForecastChart(defStart, defEnd);

    if (apApply) apApply.addEventListener('click', () => {
      renderAgentForecastChart(apStart.value, apEnd.value);
    });

    if (apReset) apReset.addEventListener('click', () => {
      const s = defStart;
      const e = defEnd;
      apStart.value = s;
      apEnd.value = e;
      renderAgentForecastChart(s, e);
    });
  } catch (e) { console.error(e); }
  // ========= End Agent Performance =========

  });
</script>
</body>
</html>
